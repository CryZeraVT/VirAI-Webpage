<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViriTTS - Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@aws-sdk/client-s3@3.454.0/dist-browser/index.js"></script>
  <style>
    .admin-card {
      background: rgba(30, 20, 51, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(217, 70, 239, 0.3);
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 800px;
      margin: 40px auto;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #d946ef; }
    .form-input {
      width: 100%;
      padding: 12px;
      background: #0f0816;
      border: 1px solid #2d1b4e;
      border-radius: 8px;
      color: white;
      font-family: inherit;
    }
    .form-textarea { height: 120px; resize: vertical; }
    .announcement-item {
      background: #1a112e;
      border: 1px solid #2d1b4e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .announcement-info h4 { margin: 0; color: #06b6d4; }
    .announcement-info p { margin: 5px 0 0; font-size: 0.9em; color: #a1a1aa; }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: bold;
      margin-left: 10px;
    }
    .badge-critical { background: #ef4444; color: white; }
    .badge-active { background: #22c55e; color: white; }
  </style>
</head>
<body>
  <div id="interactive-bg"></div>

  <div class="container">
    <header>
      <a href="index.html" class="logo">
        <img src="images/Viritts1.png" alt="ViriTTS Logo Icon" style="height: 50px;">
        <img src="images/virittstextonly.png" alt="ViriTTS Text Logo" style="height: 40px;">
      </a>
      <nav>
        <a href="admin-usage.html" style="color: #22c55e;">Token Usage</a>
        <a href="account.html">Back to Account</a>
        <a href="changelog.html">View Public Changelog</a>
      </nav>
    </header>

    <div class="admin-card">
      <h2>Admin Dashboard</h2>
      <p class="auth-subtitle">Manage system announcements and changelogs.</p>

      <div id="admin-status" class="auth-status">Checking permissions...</div>

      <div id="admin-content" class="hidden">
        <div class="auth-divider"></div>
        
        <!-- Quick Links -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
          <a href="admin-usage.html" class="btn" style="background: linear-gradient(135deg, #22c55e, #06b6d4);">
            ðŸ“Š View Token Usage Dashboard
          </a>
        </div>

        <div class="auth-divider"></div>
        
        <h3>Cloudflare R2 Configuration</h3>
        <p class="auth-helper">Enter your R2 credentials to enable file uploads and versioning.</p>
        <div class="form-group">
          <label>Account ID</label>
          <input id="r2-account-id" type="text" placeholder="xxx..." class="form-input">
        </div>
        <div class="form-group">
          <label>Access Key ID</label>
          <input id="r2-access-key" type="text" placeholder="xxx..." class="form-input">
        </div>
        <div class="form-group">
          <label>Secret Access Key</label>
          <input id="r2-secret-key" type="password" placeholder="xxx..." class="form-input">
        </div>
        <div class="form-group">
          <label>Bucket Name</label>
          <input id="r2-bucket-name" type="text" placeholder="viritts-updates" class="form-input">
        </div>
        <div class="form-group">
          <label>Public Download URL (e.g. https://pub-xxx.r2.dev)</label>
          <input id="r2-public-url" type="text" placeholder="https://..." class="form-input">
        </div>
        <button id="save-r2-config" class="btn btn-outline" style="border-color: #22c55e; color: #22c55e;">Save R2 Settings</button>

        <div class="auth-divider"></div>
        
        <h3>Publish New Update</h3>
        <p class="auth-helper">Upload a new .exe or .zip and update the version for all users.</p>
        <div class="form-group">
          <label>Select Update File</label>
          <input id="update-file" type="file" class="form-input">
        </div>
        <div id="publish-status" style="margin-bottom: 15px; font-size: 0.9em;"></div>
        <button id="publish-to-r2" class="btn" style="background: linear-gradient(135deg, #d946ef, #06b6d4);">ðŸš€ Upload & Publish to R2</button>

        <div class="auth-divider"></div>
        
        <h3>Create New Announcement</h3>
        <div class="form-group">
          <label>Version</label>
          <input id="ann-version" type="text" placeholder="e.g. 1.0.1" class="form-input">
        </div>
        <div class="form-group">
          <label>Title</label>
          <input id="ann-title" type="text" placeholder="Update Title" class="form-input">
        </div>
        <div class="form-group">
          <label>Content / Changelog</label>
          <textarea id="ann-content" placeholder="Describe the changes..." class="form-input form-textarea"></textarea>
        </div>
        <div class="form-group">
          <label>Download URL (Optional)</label>
          <input id="ann-url" type="text" placeholder="https://download.viritts.com/..." class="form-input">
        </div>
        <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
          <label style="margin-bottom: 0;">
            <input id="ann-critical" type="checkbox"> Critical Update
          </label>
          <label style="margin-bottom: 0;">
            <input id="ann-active" type="checkbox" checked> Active
          </label>
        </div>
        <button id="save-announcement" class="btn">Post Announcement</button>

        <div class="auth-divider"></div>

        <h3>Global Built-in AI Control</h3>
        <p class="auth-helper">Switch the AI provider and model used by all 'Built-in AI' users instantly.</p>
        <div class="form-group">
          <label>Provider</label>
          <select id="ai-provider" class="form-input">
            <option value="openai">OpenAI</option>
            <option value="grok">Grok (X.AI)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Model</label>
          <input id="ai-model" type="text" placeholder="e.g. gpt-4o-mini" class="form-input">
        </div>
        <button id="update-ai-config" class="btn btn-outline" style="border-color: #06b6d4; color: #06b6d4;">Update Global AI Engine</button>

        <div class="auth-divider"></div>
        <div id="announcements-list">Loading...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://rgigtqpesabuyaumibaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnaWd0cXBlc2FidXlhdW1pYmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTA2OTcsImV4cCI6MjA4NDMyNjY5N30.MaMvKpVPqCQONsNaYifkSvVFmYbT5c4HYpi_qieN4H0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById("admin-status");
    const contentEl = document.getElementById("admin-content");
    const listEl = document.getElementById("announcements-list");
    const aiProviderEl = document.getElementById("ai-provider");
    const aiModelEl = document.getElementById("ai-model");
    const r2AccountIdEl = document.getElementById("r2-account-id");
    const r2AccessKeyEl = document.getElementById("r2-access-key");
    const r2SecretKeyEl = document.getElementById("r2-secret-key");
    const r2BucketNameEl = document.getElementById("r2-bucket-name");
    const r2PublicUrlEl = document.getElementById("r2-public-url");
    const publishStatusEl = document.getElementById("publish-status");

    async function checkAdmin() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "account.html";
        return;
      }

      const { data: profile, error } = await supabase
        .from("profiles")
        .select("is_admin")
        .eq("id", user.id)
        .single();

      if (error || !profile?.is_admin) {
        statusEl.textContent = "Access Denied: You are not an admin.";
        statusEl.className = "auth-status error";
        return;
      }

      statusEl.textContent = "Welcome, Admin.";
      statusEl.className = "auth-status success";
      contentEl.classList.remove("hidden");
      loadAnnouncements();
      loadAIConfig();
      loadR2Config();
    }

    async function loadR2Config() {
      const { data, error } = await supabase
        .from("system_config")
        .select("value")
        .eq("key", "r2_storage_config")
        .single();

      if (data) {
        r2AccountIdEl.value = data.value.account_id || "";
        r2AccessKeyEl.value = data.value.access_key || "";
        r2SecretKeyEl.value = data.value.secret_key || "";
        r2BucketNameEl.value = data.value.bucket_name || "";
        r2PublicUrlEl.value = data.value.public_url || "";
      }
    }

    async function loadAIConfig() {
      const { data, error } = await supabase
        .from("system_config")
        .select("value")
        .eq("key", "builtin_ai_provider")
        .single();

      if (data) {
        aiProviderEl.value = data.value.provider;
        aiModelEl.value = data.value.model;
      }
    }

    async function loadAnnouncements() {
      const { data, error } = await supabase
        .from("announcements")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        listEl.textContent = "Error loading announcements.";
        return;
      }

      if (!data || data.length === 0) {
        listEl.textContent = "No announcements found.";
        return;
      }

      listEl.innerHTML = data.map(ann => `
        <div class="announcement-item">
          <div class="announcement-info">
            <h4>v${ann.version}: ${ann.title} 
              ${ann.is_critical ? '<span class="badge badge-critical">CRITICAL</span>' : ''}
              ${ann.active ? '<span class="badge badge-active">ACTIVE</span>' : ''}
            </h4>
            <p>${ann.content.substring(0, 100)}${ann.content.length > 100 ? '...' : ''}</p>
          </div>
          <button class="btn btn-outline delete-btn" data-id="${ann.id}" style="border-color: #ff4444; color: #ff4444; padding: 5px 10px; font-size: 0.8em;">Delete</button>
        </div>
      `).join("");

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Are you sure you want to delete this announcement?")) return;
          
          const { error } = await supabase.from("announcements").delete().eq("id", id);
          if (error) alert("Error deleting: " + error.message);
          else loadAnnouncements();
        });
      });
    }

    document.getElementById("save-announcement").addEventListener("click", async () => {
      const version = document.getElementById("ann-version").value.trim();
      const title = document.getElementById("ann-title").value.trim();
      const content = document.getElementById("ann-content").value.trim();
      const url = document.getElementById("ann-url").value.trim();
      const is_critical = document.getElementById("ann-critical").checked;
      const active = document.getElementById("ann-active").checked;

      if (!version || !title || !content) {
        alert("Please fill in version, title, and content.");
        return;
      }

      const { error } = await supabase.from("announcements").insert([{
        version, title, content, download_url: url, is_critical, active
      }]);

      if (error) {
        alert("Error saving: " + error.message);
      } else {
        alert("Announcement posted!");
        // Clear form
        document.getElementById("ann-version").value = "";
        document.getElementById("ann-title").value = "";
        document.getElementById("ann-content").value = "";
        document.getElementById("ann-url").value = "";
        loadAnnouncements();
      }
    });

    document.getElementById("save-r2-config").addEventListener("click", async () => {
      const config = {
        account_id: r2AccountIdEl.value.trim(),
        access_key: r2AccessKeyEl.value.trim(),
        secret_key: r2SecretKeyEl.value.trim(),
        bucket_name: r2BucketNameEl.value.trim(),
        public_url: r2PublicUrlEl.value.trim()
      };

      const { error } = await supabase
        .from("system_config")
        .upsert({ 
          key: "r2_storage_config", 
          value: config,
          updated_at: new Date().toISOString()
        });

      if (error) alert("Error saving R2 config: " + error.message);
      else alert("R2 Configuration saved!");
    });

    document.getElementById("publish-to-r2").addEventListener("click", async () => {
      const file = document.getElementById("update-file").files[0];
      const version = document.getElementById("ann-version").value.trim();
      const title = document.getElementById("ann-title").value.trim();
      const content = document.getElementById("ann-content").value.trim();
      const is_critical = document.getElementById("ann-critical").checked;

      if (!file || !version || !title || !content) {
        alert("Please fill in version, title, content and select a file.");
        return;
      }

      publishStatusEl.textContent = "â³ Initializing upload...";
      publishStatusEl.style.color = "var(--text-secondary)";

      try {
        const { S3Client, PutObjectCommand } = window["@aws-sdk/client-s3"];
        
        const r2Client = new S3Client({
          region: "auto",
          endpoint: `https://${r2AccountIdEl.value.trim()}.r2.cloudflarestorage.com`,
          credentials: {
            accessKeyId: r2AccessKeyEl.value.trim(),
            secretAccessKey: r2SecretKeyEl.value.trim(),
          },
        });

        // 1. Upload the main file
        const remotePath = `updates/${version}/${file.name}`;
        publishStatusEl.textContent = `â³ Uploading ${file.name}...`;
        
        await r2Client.send(new PutObjectCommand({
          Bucket: r2BucketNameEl.value.trim(),
          Key: remotePath,
          Body: file,
          ContentType: file.type
        }));

        // 2. Create and upload version.json
        publishStatusEl.textContent = "â³ Updating version.json...";
        const publicBaseUrl = r2PublicUrlEl.value.trim().replace(/\/$/, "");
        const downloadUrl = `${publicBaseUrl}/${remotePath}`;
        
        const versionData = {
          version,
          title,
          content,
          is_critical,
          download_url: downloadUrl,
          publish_date: new Date().toISOString()
        };

        await r2Client.send(new PutObjectCommand({
          Bucket: r2BucketNameEl.value.trim(),
          Key: "version.json",
          Body: JSON.stringify(versionData, null, 2),
          ContentType: "application/json"
        }));

        // 3. Post announcement to Supabase
        publishStatusEl.textContent = "â³ Posting announcement...";
        const { error: annError } = await supabase.from("announcements").insert([{
          version, title, content, download_url: downloadUrl, is_critical, active: true
        }]);

        if (annError) throw annError;

        publishStatusEl.textContent = "âœ… Successfully published to R2 and Supabase!";
        publishStatusEl.style.color = "var(--success)";
        loadAnnouncements();
        
      } catch (err) {
        console.error(err);
        publishStatusEl.textContent = "âŒ Error: " + err.message;
        publishStatusEl.style.color = "var(--error)";
      }
    });

    document.getElementById("update-ai-config").addEventListener("click", async () => {
      const provider = aiProviderEl.value;
      const model = aiModelEl.value.trim();

      if (!model) {
        alert("Please enter a model name.");
        return;
      }

      const { error } = await supabase
        .from("system_config")
        .upsert({ 
          key: "builtin_ai_provider", 
          value: { provider, model },
          updated_at: new Date().toISOString()
        });

      if (error) {
        alert("Error updating AI config: " + error.message);
      } else {
        alert("Global AI Engine updated! All apps will switch on next launch.");
      }
    });

    checkAdmin();
  </script>
</body>
</html>
