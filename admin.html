<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViriTTS - Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    .admin-card {
      background: rgba(30, 20, 51, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(217, 70, 239, 0.3);
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 800px;
      margin: 40px auto;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #d946ef; }
    .form-input {
      width: 100%;
      padding: 12px;
      background: #0f0816;
      border: 1px solid #2d1b4e;
      border-radius: 8px;
      color: white;
      font-family: inherit;
    }
    .form-textarea { height: 120px; resize: vertical; }
    .announcement-item {
      background: #1a112e;
      border: 1px solid #2d1b4e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .announcement-info h4 { margin: 0; color: #06b6d4; }
    .announcement-info p { margin: 5px 0 0; font-size: 0.9em; color: #a1a1aa; }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: bold;
      margin-left: 10px;
    }
    .badge-critical { background: #ef4444; color: white; }
    .badge-active { background: #22c55e; color: white; }
    
    input[type="radio"] {
      accent-color: #22c55e;
    }

    /* Tab Styles */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(157, 78, 221, 0.2);
      padding-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .nav-tab {
      padding: 12px 20px;
      background: transparent;
      border: 1px solid #2d1b4e;
      color: #a1a1aa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nav-tab.active {
      background: linear-gradient(135deg, #d946ef, #06b6d4);
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 15px rgba(217, 70, 239, 0.3);
    }
    
    .nav-tab:hover:not(.active) {
      border-color: #d946ef;
      color: #d946ef;
      background: rgba(217, 70, 239, 0.05);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }
    
    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .quick-links {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div id="interactive-bg"></div>

  <div class="container">
    <header>
      <a href="index.html" class="logo">
        <img src="images/Viritts1.png" alt="ViriTTS Logo Icon" style="height: 50px;">
        <img src="images/virittstextonly.png" alt="ViriTTS Text Logo" style="height: 40px;">
      </a>
      <nav>
        <a href="admin-usage.html" style="color: #22c55e;">Token Usage</a>
        <a href="account.html">Back to Account</a>
        <a href="changelog.html">View Public Changelog</a>
      </nav>
    </header>

    <div class="admin-card">
      <h2>Admin Dashboard</h2>
      <p class="auth-subtitle">Manage system announcements and changelogs.</p>

      <div id="admin-status" class="auth-status">Checking permissions...</div>

      <div id="admin-content" class="hidden">
        <div class="auth-divider"></div>
        
        <!-- Quick Links -->
        <div class="quick-links">
          <a href="admin-usage.html" class="btn" style="background: linear-gradient(135deg, #22c55e, #06b6d4); font-size: 0.9rem; padding: 10px 20px;">
            üìä View Token Usage Dashboard
          </a>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
          <button class="nav-tab active" data-tab="publish">üöÄ Publish Update</button>
          <button class="nav-tab" data-tab="announcements">üì¢ Announcements</button>
          <button class="nav-tab" data-tab="ai-engine">ü§ñ AI Engine</button>
          <button class="nav-tab" data-tab="storage">‚òÅÔ∏è Storage (R2)</button>
        </div>

        <!-- Tab: Publish Update -->
        <div class="tab-content active" id="tab-publish">
          <h3>Published Versions</h3>
          <p class="auth-helper">Select which version users should download. Only one version can be active at a time.</p>
          
          <div id="versions-list" style="margin-top: 20px;">
            <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
              Loading versions...
            </div>
          </div>
        </div>

        <!-- Tab: Announcements -->
        <div class="tab-content" id="tab-announcements">
          <h3>Create Manual Announcement</h3>
          <p class="auth-helper">Post a notice without uploading a new file (for non-version announcements).</p>
          
          <div class="form-group">
            <label>Version</label>
            <input id="manual-version" type="text" placeholder="e.g. 1.0.1" class="form-input">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input id="manual-title" type="text" placeholder="Announcement Title" class="form-input">
          </div>
          <div class="form-group">
            <label>Content</label>
            <textarea id="manual-content" placeholder="Announcement content..." class="form-input form-textarea"></textarea>
          </div>
          <div class="form-group">
            <label>Download URL (Optional)</label>
            <input id="manual-url" type="text" placeholder="https://download.viritts.com/..." class="form-input">
          </div>
          <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
            <label style="margin-bottom: 0;">
              <input id="manual-critical" type="checkbox"> Critical
            </label>
            <label style="margin-bottom: 0;">
              <input id="manual-active" type="checkbox" checked> Active
            </label>
          </div>
          <button id="save-announcement" class="btn" style="margin-bottom: 30px; width: 100%;">Post Announcement</button>

          <div class="auth-divider"></div>
          <h3>Existing Announcements</h3>
          <div id="announcements-list">Loading...</div>
        </div>

        <!-- Tab: AI Engine -->
        <div class="tab-content" id="tab-ai-engine">
          <h3>Global Built-in AI Control</h3>
          <p class="auth-helper">Switch the AI provider and model used by all 'Built-in AI' users instantly.</p>
          <div class="form-group">
            <label>Provider</label>
            <select id="ai-provider" class="form-input">
              <option value="openai">OpenAI</option>
              <option value="grok">Grok (X.AI)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Model</label>
            <input id="ai-model" type="text" placeholder="e.g. gpt-4o-mini" class="form-input">
          </div>
          <button id="update-ai-config" class="btn btn-outline" style="border-color: #06b6d4; color: #06b6d4; width: 100%;">Update Global AI Engine</button>
        </div>

        <!-- Tab: Storage -->
        <div class="tab-content" id="tab-storage">
          <h3>Cloudflare R2 Configuration</h3>
          <p class="auth-helper">Enter your R2 credentials to enable file uploads and versioning.</p>
          <div class="form-group">
            <label>Account ID</label>
            <input id="r2-account-id" type="text" placeholder="xxx..." class="form-input">
          </div>
          <div class="form-group">
            <label>Access Key ID</label>
            <input id="r2-access-key" type="text" placeholder="xxx..." class="form-input">
          </div>
          <div class="form-group">
            <label>Secret Access Key</label>
            <input id="r2-secret-key" type="password" placeholder="xxx..." class="form-input">
          </div>
          <div class="form-group">
            <label>Bucket Name</label>
            <input id="r2-bucket-name" type="text" placeholder="viritts-updates" class="form-input">
          </div>
          <div class="form-group">
            <label>Public Download URL (e.g. https://pub-xxx.r2.dev)</label>
            <input id="r2-public-url" type="text" placeholder="https://..." class="form-input">
          </div>
          <button id="save-r2-config" class="btn btn-outline" style="border-color: #22c55e; color: #22c55e; width: 100%;">Save R2 Settings</button>

          <div class="auth-divider"></div>

          <h3>Upload New Version to R2</h3>
          <p class="auth-helper">Upload a new .exe or .zip file to your R2 bucket.</p>
          
          <div class="form-group">
            <label>Version</label>
            <input id="upload-version" type="text" placeholder="e.g. 1.0.1" class="form-input">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input id="upload-title" type="text" placeholder="Update Title" class="form-input">
          </div>
          <div class="form-group">
            <label>Content / Changelog</label>
            <textarea id="upload-content" placeholder="Describe the changes..." class="form-input form-textarea"></textarea>
          </div>
          
          <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
            <label style="margin-bottom: 0;">
              <input id="upload-critical" type="checkbox"> Critical Update
            </label>
          </div>

          <div class="form-group">
            <label>Select Update File</label>
            <input id="update-file" type="file" class="form-input">
          </div>
          
          <div id="upload-status" style="margin-bottom: 15px; font-size: 0.9em;"></div>
          <button id="upload-to-r2" class="btn" style="width: 100%; background: linear-gradient(135deg, #d946ef, #06b6d4);">‚òÅÔ∏è Upload to R2 Storage</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    
    // Helper function to sign AWS requests (S3/R2 compatible)
    async function signRequest(method, url, headers, body, credentials) {
      const encoder = new TextEncoder();
      
      async function hmacSha256(key, message) {
        const cryptoKey = await crypto.subtle.importKey(
          "raw", key, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
        );
        return new Uint8Array(await crypto.subtle.sign("HMAC", cryptoKey, encoder.encode(message)));
      }
      
      async function sha256(message) {
        const hash = await crypto.subtle.digest("SHA-256", typeof message === "string" ? encoder.encode(message) : message);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
      }
      
      const urlObj = new URL(url);
      const datetime = new Date().toISOString().replace(/[:-]|\.\d{3}/g, "");
      const date = datetime.slice(0, 8);
      const host = urlObj.host;
      const region = "auto";
      const service = "s3";
      
      const payloadHash = await sha256(body || "");
      
      const canonicalHeaders = `host:${host}\nx-amz-content-sha256:${payloadHash}\nx-amz-date:${datetime}\n`;
      const signedHeaders = "host;x-amz-content-sha256;x-amz-date";
      
      const canonicalRequest = [
        method,
        urlObj.pathname,
        urlObj.search.slice(1),
        canonicalHeaders,
        signedHeaders,
        payloadHash
      ].join("\n");
      
      const scope = `${date}/${region}/${service}/aws4_request`;
      const stringToSign = [
        "AWS4-HMAC-SHA256",
        datetime,
        scope,
        await sha256(canonicalRequest)
      ].join("\n");
      
      let key = encoder.encode("AWS4" + credentials.secretAccessKey);
      key = await hmacSha256(key, date);
      key = await hmacSha256(key, region);
      key = await hmacSha256(key, service);
      key = await hmacSha256(key, "aws4_request");
      
      const signature = Array.from(await hmacSha256(key, stringToSign))
        .map(b => b.toString(16).padStart(2, "0")).join("");
      
      return {
        "x-amz-date": datetime,
        "x-amz-content-sha256": payloadHash,
        "Authorization": `AWS4-HMAC-SHA256 Credential=${credentials.accessKeyId}/${scope}, SignedHeaders=${signedHeaders}, Signature=${signature}`
      };
    }

    const SUPABASE_URL = "https://rgigtqpesabuyaumibaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnaWd0cXBlc2FidXlhdW1pYmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTA2OTcsImV4cCI6MjA4NDMyNjY5N30.MaMvKpVPqCQONsNaYifkSvVFmYbT5c4HYpi_qieN4H0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById("admin-status");
    const contentEl = document.getElementById("admin-content");
    const listEl = document.getElementById("announcements-list");
    const aiProviderEl = document.getElementById("ai-provider");
    const aiModelEl = document.getElementById("ai-model");
    const r2AccountIdEl = document.getElementById("r2-account-id");
    const r2AccessKeyEl = document.getElementById("r2-access-key");
    const r2SecretKeyEl = document.getElementById("r2-secret-key");
    const r2BucketNameEl = document.getElementById("r2-bucket-name");
    const r2PublicUrlEl = document.getElementById("r2-public-url");

    async function checkAdmin() {
      try {
        console.log("Checking admin status...");
        statusEl.textContent = "üîç Verifying permissions...";
        
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        console.log("User check:", user ? `Logged in as ${user.email}` : "Not logged in", userError);
        
        if (userError) {
          console.error("Auth error:", userError);
          statusEl.textContent = "‚ö†Ô∏è Auth error: " + userError.message;
          statusEl.className = "auth-status error";
          setTimeout(() => window.location.href = "account.html", 2000);
          return;
        }
        
        if (!user) {
          console.log("No user found, redirecting to login...");
          statusEl.textContent = "‚ö†Ô∏è Not logged in. Redirecting...";
          setTimeout(() => window.location.href = "account.html", 1000);
          return;
        }

        statusEl.textContent = `üîç Checking admin rights for ${user.email}...`;
        
        const { data: profile, error: profileError } = await supabase
          .from("profiles")
          .select("is_admin")
          .eq("id", user.id)
          .single();

        console.log("Profile check:", profile, "Error:", profileError);

        if (profileError) {
          console.error("Profile error:", profileError);
          statusEl.textContent = "‚ö†Ô∏è Error checking profile: " + profileError.message;
          statusEl.className = "auth-status error";
          return;
        }
        
        if (!profile?.is_admin) {
          console.log("User is not admin");
          statusEl.textContent = "‚ùå Access Denied: You are not an admin.";
          statusEl.className = "auth-status error";
          return;
        }

        console.log("Admin access granted!");
        statusEl.textContent = "‚úÖ Admin Access Granted";
        statusEl.className = "auth-status success";
        contentEl.classList.remove("hidden");
        
        loadAnnouncements();
        loadAIConfig();
        loadR2Config();
        loadVersions();
      } catch (err) {
        console.error("Unexpected error in checkAdmin:", err);
        statusEl.textContent = "‚ùå Unexpected error: " + err.message;
        statusEl.className = "auth-status error";
      }
    }

    async function loadVersions() {
      try {
        console.log("Loading versions...");
        const listEl = document.getElementById("versions-list");
        
        const { data, error } = await supabase
          .from("r2_versions")
          .select("*")
          .order("created_at", { ascending: false });

        console.log("Versions loaded:", data, "Error:", error);

        if (error) {
          console.error("Error loading versions:", error);
          listEl.innerHTML = `<p style="color: var(--error);">Error loading versions: ${error.message}</p>`;
          return;
        }

        if (!data || data.length === 0) {
          listEl.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 30px;">No versions uploaded yet. Go to Storage tab to upload your first version.</p>`;
          return;
        }

      listEl.innerHTML = data.map(ver => `
        <div class="announcement-item" style="flex-direction: column; align-items: flex-start; gap: 15px;">
          <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
            <div class="announcement-info" style="flex: 1;">
              <h4 style="display: flex; align-items: center; gap: 10px;">
                v${ver.version}: ${ver.title}
                ${ver.is_critical ? '<span class="badge badge-critical">CRITICAL</span>' : ''}
                ${ver.is_active ? '<span class="badge badge-active">ACTIVE</span>' : '<span class="badge" style="background: #2d1b4e;">INACTIVE</span>'}
              </h4>
              <p>${ver.content ? ver.content.substring(0, 100) : 'No changelog'}${ver.content && ver.content.length > 100 ? '...' : ''}</p>
              <p style="font-size: 0.85em; color: #6b7280; margin-top: 5px;">
                üì¶ ${ver.file_name} ‚Ä¢ Uploaded: ${new Date(ver.created_at).toLocaleDateString()}
              </p>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
              <input type="radio" name="active-version" value="${ver.id}" ${ver.is_active ? 'checked' : ''} 
                onchange="setActiveVersion('${ver.id}')" 
                style="width: 20px; height: 20px; cursor: pointer;">
              <span style="color: #22c55e; font-weight: 600;">Set as Active</span>
            </label>
          </div>
          <div style="display: flex; gap: 10px; width: 100%;">
            <a href="${ver.download_url}" target="_blank" class="btn btn-outline" style="border-color: #06b6d4; color: #06b6d4; padding: 8px 16px; font-size: 0.85em; text-decoration: none;">
              ‚¨áÔ∏è Download
            </a>
            <button class="btn btn-outline delete-version-btn" data-id="${ver.id}" style="border-color: #ff4444; color: #ff4444; padding: 8px 16px; font-size: 0.85em;">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `).join("");

      // Add delete handlers
      document.querySelectorAll(".delete-version-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Are you sure you want to delete this version?")) return;
          
          const { error } = await supabase.from("r2_versions").delete().eq("id", id);
          if (error) {
            alert("Error deleting: " + error.message);
          } else {
            loadVersions();
          }
        });
      });
    } catch (err) {
      console.error("Error in loadVersions:", err);
      document.getElementById("versions-list").innerHTML = 
        `<p style="color: var(--error);">Unexpected error: ${err.message}</p>`;
    }
  }

    window.setActiveVersion = async function(versionId) {
      // First, deactivate all versions
      await supabase
        .from("r2_versions")
        .update({ is_active: false })
        .neq("id", "00000000-0000-0000-0000-000000000000");
      
      // Then activate the selected one
      const { error } = await supabase
        .from("r2_versions")
        .update({ is_active: true })
        .eq("id", versionId);

      if (error) {
        alert("Error setting active version: " + error.message);
      } else {
        // Reload to reflect changes
        loadVersions();
        
        // Also update announcement to match
        const { data: version } = await supabase
          .from("r2_versions")
          .select("*")
          .eq("id", versionId)
          .single();
        
        if (version) {
          // Deactivate old announcements
          await supabase
            .from("announcements")
            .update({ active: false })
            .neq("id", "00000000-0000-0000-0000-000000000000");
          
          // Create/update announcement for this version
          await supabase.from("announcements").upsert({
            version: version.version,
            title: version.title,
            content: version.content,
            download_url: version.download_url,
            is_critical: version.is_critical,
            active: true
          }, { onConflict: "version" });
          
          alert(`Version ${version.version} is now active!`);
        }
      }
    };

    async function loadR2Config() {
      try {
        console.log("Loading R2 config...");
        const { data, error } = await supabase
          .from("system_config")
          .select("value")
          .eq("key", "r2_storage_config")
          .single();

        console.log("R2 config loaded:", data ? "Found" : "Not found", "Error:", error);

        if (error && error.code !== 'PGRST116') {
          // PGRST116 = no rows returned, which is fine (config not set yet)
          console.error("Error loading R2 config:", error);
        }

        if (data) {
          r2AccountIdEl.value = data.value.account_id || "";
          r2AccessKeyEl.value = data.value.access_key || "";
          r2SecretKeyEl.value = data.value.secret_key || "";
          r2BucketNameEl.value = data.value.bucket_name || "";
          r2PublicUrlEl.value = data.value.public_url || "";
        }
      } catch (err) {
        console.error("Unexpected error in loadR2Config:", err);
      }
    }

    async function loadAIConfig() {
      try {
        console.log("Loading AI config...");
        const { data, error } = await supabase
          .from("system_config")
          .select("value")
          .eq("key", "builtin_ai_provider")
          .single();

        console.log("AI config loaded:", data ? "Found" : "Not found", "Error:", error);

        if (error && error.code !== 'PGRST116') {
          console.error("Error loading AI config:", error);
        }

        if (data) {
          aiProviderEl.value = data.value.provider;
          aiModelEl.value = data.value.model;
        }
      } catch (err) {
        console.error("Unexpected error in loadAIConfig:", err);
      }
    }

    async function loadAnnouncements() {
      try {
        console.log("Loading announcements...");
        const { data, error } = await supabase
          .from("announcements")
          .select("*")
          .order("created_at", { ascending: false });

        console.log("Announcements loaded:", data ? `${data.length} found` : "None", "Error:", error);

        if (error) {
          console.error("Error loading announcements:", error);
          listEl.textContent = "Error loading announcements: " + error.message;
          return;
        }

        if (!data || data.length === 0) {
          listEl.textContent = "No announcements found.";
          return;
        }

      listEl.innerHTML = data.map(ann => `
        <div class="announcement-item">
          <div class="announcement-info">
            <h4>v${ann.version}: ${ann.title} 
              ${ann.is_critical ? '<span class="badge badge-critical">CRITICAL</span>' : ''}
              ${ann.active ? '<span class="badge badge-active">ACTIVE</span>' : ''}
            </h4>
            <p>${ann.content.substring(0, 100)}${ann.content.length > 100 ? '...' : ''}</p>
          </div>
          <button class="btn btn-outline delete-btn" data-id="${ann.id}" style="border-color: #ff4444; color: #ff4444; padding: 5px 10px; font-size: 0.8em;">Delete</button>
        </div>
      `).join("");

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Are you sure you want to delete this announcement?")) return;
          
          const { error } = await supabase.from("announcements").delete().eq("id", id);
          if (error) alert("Error deleting: " + error.message);
          else loadAnnouncements();
        });
      });
    } catch (err) {
      console.error("Unexpected error in loadAnnouncements:", err);
      listEl.textContent = "Unexpected error: " + err.message;
    }
  }

    document.getElementById("save-announcement").addEventListener("click", async () => {
      const version = document.getElementById("manual-version").value.trim();
      const title = document.getElementById("manual-title").value.trim();
      const content = document.getElementById("manual-content").value.trim();
      const url = document.getElementById("manual-url").value.trim();
      const is_critical = document.getElementById("manual-critical").checked;
      const active = document.getElementById("manual-active").checked;

      if (!version || !title || !content) {
        alert("Please fill in version, title, and content.");
        return;
      }

      const { error } = await supabase.from("announcements").insert([{
        version, title, content, download_url: url, is_critical, active
      }]);

      if (error) {
        alert("Error saving: " + error.message);
      } else {
        alert("Announcement posted!");
        // Clear form
        document.getElementById("manual-version").value = "";
        document.getElementById("manual-title").value = "";
        document.getElementById("manual-content").value = "";
        document.getElementById("manual-url").value = "";
        loadAnnouncements();
      }
    });

    // Tab switching logic
    document.querySelectorAll(".nav-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        // Remove active class from all tabs and contents
        document.querySelectorAll(".nav-tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add("active");
        const tabId = `tab-${tab.dataset.tab}`;
        document.getElementById(tabId).classList.add("active");
      });
    });

    document.getElementById("save-r2-config").addEventListener("click", async () => {
      const config = {
        account_id: r2AccountIdEl.value.trim(),
        access_key: r2AccessKeyEl.value.trim(),
        secret_key: r2SecretKeyEl.value.trim(),
        bucket_name: r2BucketNameEl.value.trim(),
        public_url: r2PublicUrlEl.value.trim()
      };

      const { error } = await supabase
        .from("system_config")
        .upsert({ 
          key: "r2_storage_config", 
          value: config,
          updated_at: new Date().toISOString()
        });

      if (error) alert("Error saving R2 config: " + error.message);
      else alert("R2 Configuration saved!");
    });

    document.getElementById("upload-to-r2").addEventListener("click", async () => {
      const file = document.getElementById("update-file").files[0];
      const version = document.getElementById("upload-version").value.trim();
      const title = document.getElementById("upload-title").value.trim();
      const content = document.getElementById("upload-content").value.trim();
      const is_critical = document.getElementById("upload-critical").checked;
      const statusEl = document.getElementById("upload-status");

      if (!file || !version || !title || !content) {
        alert("Please fill in version, title, content and select a file.");
        return;
      }

      statusEl.textContent = "‚è≥ Initializing upload...";
      statusEl.style.color = "var(--text-secondary)";

      try {
        const accountId = r2AccountIdEl.value.trim();
        const bucketName = r2BucketNameEl.value.trim();
        const credentials = {
          accessKeyId: r2AccessKeyEl.value.trim(),
          secretAccessKey: r2SecretKeyEl.value.trim(),
        };

        // 1. Read file as ArrayBuffer (browser-compatible)
        const remotePath = `updates/${version}/${file.name}`;
        statusEl.textContent = `‚è≥ Reading ${file.name}...`;
        
        const fileBuffer = await file.arrayBuffer();
        const fileBytes = new Uint8Array(fileBuffer);
        
        statusEl.textContent = `‚è≥ Uploading ${file.name}...`;
        
        // Build the R2 URL and sign the request
        const r2Url = `https://${bucketName}.${accountId}.r2.cloudflarestorage.com/${remotePath}`;
        const authHeaders = await signRequest("PUT", r2Url, {}, fileBytes, credentials);
        
        const uploadResponse = await fetch(r2Url, {
          method: "PUT",
          headers: {
            ...authHeaders,
            "Content-Type": file.type || "application/octet-stream",
          },
          body: fileBytes
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          throw new Error(`Upload failed: ${uploadResponse.status} - ${errorText}`);
        }

        // 2. Save version to Supabase
        statusEl.textContent = "‚è≥ Saving version info...";
        const publicBaseUrl = r2PublicUrlEl.value.trim().replace(/\/$/, "");
        const downloadUrl = `${publicBaseUrl}/${remotePath}`;
        
        const { data: userData } = await supabase.auth.getUser();
        
        const { error: versionError } = await supabase.from("r2_versions").insert([{
          version,
          title,
          content,
          file_name: file.name,
          file_path: remotePath,
          download_url: downloadUrl,
          is_critical,
          is_active: false,
          uploaded_by: userData?.user?.id
        }]);

        if (versionError) throw versionError;

        statusEl.textContent = "‚úÖ Successfully uploaded to R2!";
        statusEl.style.color = "var(--success)";
        
        // Clear form
        document.getElementById("upload-version").value = "";
        document.getElementById("upload-title").value = "";
        document.getElementById("upload-content").value = "";
        document.getElementById("upload-critical").checked = false;
        document.getElementById("update-file").value = "";
        
        // Reload versions list
        loadVersions();
        
        alert("Upload complete! Go to 'Publish Update' tab to set it as active.");
        
      } catch (err) {
        console.error(err);
        statusEl.textContent = "‚ùå Error: " + err.message;
        statusEl.style.color = "var(--error)";
      }
    });

    document.getElementById("update-ai-config").addEventListener("click", async () => {
      const provider = aiProviderEl.value;
      const model = aiModelEl.value.trim();

      if (!model) {
        alert("Please enter a model name.");
        return;
      }

      const { error } = await supabase
        .from("system_config")
        .upsert({ 
          key: "builtin_ai_provider", 
          value: { provider, model },
          updated_at: new Date().toISOString()
        });

      if (error) {
        alert("Error updating AI config: " + error.message);
      } else {
        alert("Global AI Engine updated! All apps will switch on next launch.");
      }
    });

    checkAdmin();
  </script>
</body>
</html>
