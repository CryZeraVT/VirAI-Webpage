<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViriTTS - Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    .admin-card {
      background: rgba(30, 20, 51, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(217, 70, 239, 0.3);
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 800px;
      margin: 40px auto;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #d946ef; }
    .form-input {
      width: 100%;
      padding: 12px;
      background: #0f0816;
      border: 1px solid #2d1b4e;
      border-radius: 8px;
      color: white;
      font-family: inherit;
    }
    .form-textarea { height: 120px; resize: vertical; }
    .announcement-item {
      background: #1a112e;
      border: 1px solid #2d1b4e;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .announcement-info h4 { margin: 0; color: #06b6d4; }
    .announcement-info p { margin: 5px 0 0; font-size: 0.9em; color: #a1a1aa; }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: bold;
      margin-left: 10px;
    }
    .badge-critical { background: #ef4444; color: white; }
    .badge-active { background: #22c55e; color: white; }
    
    input[type="radio"] {
      accent-color: #22c55e;
    }

    /* Tab Styles */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid rgba(157, 78, 221, 0.2);
      padding-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .nav-tab {
      padding: 12px 20px;
      background: transparent;
      border: 1px solid #2d1b4e;
      color: #a1a1aa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nav-tab.active {
      background: linear-gradient(135deg, #d946ef, #06b6d4);
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 15px rgba(217, 70, 239, 0.3);
    }
    
    .nav-tab:hover:not(.active) {
      border-color: #d946ef;
      color: #d946ef;
      background: rgba(217, 70, 239, 0.05);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }
    
    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .quick-links {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div id="interactive-bg"></div>

  <div class="container">
    <header>
      <a href="index.html" class="logo">
        <img src="images/Viritts1.png" alt="ViriTTS Logo Icon" style="height: 50px;">
        <img src="images/virittstextonly.png" alt="ViriTTS Text Logo" style="height: 40px;">
      </a>
      <nav>
        <a href="admin-usage.html" style="color: #22c55e;">Token Usage</a>
        <a href="account.html">Back to Account</a>
        <a href="changelog.html">View Public Changelog</a>
      </nav>
    </header>

    <div class="admin-card">
      <h2>Admin Dashboard</h2>
      <p class="auth-subtitle">Manage system announcements and changelogs.</p>

      <div id="admin-status" class="auth-status">Checking permissions...</div>

      <div id="admin-content" class="hidden">
        <div class="auth-divider"></div>
        
        <!-- Quick Links -->
        <div class="quick-links">
          <a href="admin-usage.html" class="btn" style="background: linear-gradient(135deg, #22c55e, #06b6d4); font-size: 0.9rem; padding: 10px 20px;">
            ğŸ“Š View Token Usage Dashboard
          </a>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
          <button class="nav-tab active" data-tab="publish">ğŸš€ Publish Update</button>
          <button class="nav-tab" data-tab="announcements">ğŸ“¢ Announcements</button>
          <button class="nav-tab" data-tab="ai-engine">ğŸ¤– AI Engine</button>
          <button class="nav-tab" data-tab="licenses">ğŸ”‘ Licenses</button>
          <button class="nav-tab" data-tab="users">ğŸ‘¥ Users</button>
          <button class="nav-tab" data-tab="beta-signups">ğŸ§ª Beta Signups <span id="beta-signups-badge" style="background:#d946ef;color:white;border-radius:10px;padding:2px 7px;font-size:0.75em;margin-left:4px;display:none;"></span></button>
          <button class="nav-tab" data-tab="storage">â˜ï¸ Storage (R2)</button>
        </div>

        <!-- Tab: Publish Update -->
        <div class="tab-content active" id="tab-publish">
          <h3>Published Versions</h3>
          <p class="auth-helper">Select which version users should download. Only one version can be active at a time.</p>
          
          <div id="versions-list" style="margin-top: 20px;">
            <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
              Loading versions...
            </div>
          </div>
        </div>

        <!-- Tab: Announcements -->
        <div class="tab-content" id="tab-announcements">
          <h3>Create Manual Announcement</h3>
          <p class="auth-helper">Post a notice without uploading a new file (for non-version announcements).</p>
          
          <div class="form-group">
            <label>Version</label>
            <input id="manual-version" type="text" placeholder="e.g. 1.0.1" class="form-input">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input id="manual-title" type="text" placeholder="Announcement Title" class="form-input">
          </div>
          <div class="form-group">
            <label>Content</label>
            <textarea id="manual-content" placeholder="Announcement content..." class="form-input form-textarea"></textarea>
          </div>
          <div class="form-group">
            <label>Download URL (Optional)</label>
            <input id="manual-url" type="text" placeholder="https://download.viritts.com/..." class="form-input">
          </div>
          <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
            <label style="margin-bottom: 0;">
              <input id="manual-critical" type="checkbox"> Critical
            </label>
            <label style="margin-bottom: 0;">
              <input id="manual-active" type="checkbox" checked> Active
            </label>
          </div>
          <button id="save-announcement" class="btn" style="margin-bottom: 30px; width: 100%;">Post Announcement</button>

          <div class="auth-divider"></div>
          <h3>Existing Announcements</h3>
          <div id="announcements-list">Loading...</div>
        </div>

        <!-- Tab: AI Engine -->
        <div class="tab-content" id="tab-ai-engine">
          <h3>Global Built-in AI Control</h3>
          <p class="auth-helper">Switch the AI provider and model used by all 'Built-in AI' users instantly.</p>
          <div class="form-group">
            <label>Provider</label>
            <select id="ai-provider" class="form-input">
              <option value="openai">OpenAI</option>
              <option value="grok">Grok (X.AI)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Model</label>
            <input id="ai-model" type="text" placeholder="e.g. gpt-4o-mini" class="form-input">
          </div>
          <button id="update-ai-config" class="btn btn-outline" style="border-color: #06b6d4; color: #06b6d4; width: 100%;">Update Global AI Engine</button>
        </div>

        <!-- Tab: Licenses -->
        <div class="tab-content" id="tab-licenses">
          <h3>Generate Beta License Key</h3>
          <p class="auth-helper">Create a new license key and assign it to a user's email.</p>
          
          <div class="form-group">
            <label>User Email</label>
            <input id="license-email" type="email" placeholder="user@example.com" class="form-input">
          </div>
          <div class="form-group">
            <label>License Key (Leave blank to auto-generate)</label>
            <input id="license-key-input" type="text" placeholder="VIRI-BETA-XXXX-XXXX" class="form-input">
          </div>
          <div class="form-group">
            <label>Duration (Days)</label>
            <input id="license-duration" type="number" value="30" class="form-input">
          </div>
          <div class="form-group">
            <label>Initial Status</label>
            <select id="license-status-select" class="form-input">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          
          <div id="license-status" style="margin-bottom: 15px; font-size: 0.9em;"></div>
          <button id="generate-license" class="btn" style="width: 100%; background: linear-gradient(135deg, #22c55e, #06b6d4);">ğŸ”‘ Generate & Assign License</button>

          <div class="auth-divider"></div>
          <h3>Recent Licenses</h3>
          <div id="admin-licenses-list">Loading...</div>
        </div>

        <!-- Tab: Users -->
        <div class="tab-content" id="tab-users">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:8px;">
            <div>
              <h3 style="margin:0;">Users</h3>
              <p class="auth-helper" style="margin:4px 0 0;">
                View accounts and permanently delete a user (auth + related records).
              </p>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <input id="users-search" class="form-input" type="text" placeholder="Search email..." style="width:240px; padding:8px 12px;" />
              <button id="refresh-users" class="btn btn-outline" style="border-color:#06b6d4;color:#06b6d4;padding:8px 16px;">ğŸ”„ Refresh</button>
            </div>
          </div>
          <div id="users-list" style="margin-top:16px;">
            <div style="text-align:center;padding:30px;color:var(--text-secondary);">Loading users...</div>
          </div>
        </div>

        <!-- Tab: Beta Signups -->
        <div class="tab-content" id="tab-beta-signups">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:8px;">
            <div>
              <h3 style="margin:0;">Beta Signups</h3>
              <p class="auth-helper" style="margin:4px 0 0;">People who applied via the beta signup page. Approve to auto-generate a license key and send it to their email.</p>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <select id="beta-filter" class="form-input" style="width:auto; padding:8px 12px;">
                <option value="all">All</option>
                <option value="pending" selected>Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
              <button id="refresh-signups" class="btn btn-outline" style="border-color:#06b6d4;color:#06b6d4;padding:8px 16px;">ğŸ”„ Refresh</button>
            </div>
          </div>
          <div id="beta-signups-list" style="margin-top:16px;">
            <div style="text-align:center;padding:30px;color:var(--text-secondary);">Loading signups...</div>
          </div>
        </div>

        <!-- Tab: Storage -->
        <div class="tab-content" id="tab-storage">
          <h3>Cloudflare R2 Configuration</h3>
          <p class="auth-helper">Enter your R2 credentials to enable file uploads and versioning.</p>
          <div class="form-group">
            <label>Account ID</label>
            <input id="r2-account-id" type="text" placeholder="xxx..." class="form-input">
          </div>
          <div class="form-group">
            <label>Access Key ID</label>
            <input id="r2-access-key" type="text" placeholder="xxx..." class="form-input">
          </div>
          <div class="form-group">
            <label>Secret Access Key</label>
            <input id="r2-secret-key" type="password" placeholder="xxx..." class="form-input">
          </div>
          <div class="form-group">
            <label>Bucket Name</label>
            <input id="r2-bucket-name" type="text" placeholder="viritts-updates" class="form-input">
          </div>
          <div class="form-group">
            <label>Public Download URL (e.g. https://pub-xxx.r2.dev)</label>
            <input id="r2-public-url" type="text" placeholder="https://..." class="form-input">
          </div>
          <button id="save-r2-config" class="btn btn-outline" style="border-color: #22c55e; color: #22c55e; width: 100%;">Save R2 Settings</button>

          <div class="auth-divider"></div>

          <h3>Upload New Version to R2</h3>
          <p class="auth-helper">Upload a new .exe or .zip file to your R2 bucket.</p>
          
          <div class="form-group">
            <label>Version</label>
            <input id="upload-version" type="text" placeholder="e.g. 1.0.1" class="form-input">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input id="upload-title" type="text" placeholder="Update Title" class="form-input">
          </div>
          <div class="form-group">
            <label>Content / Changelog</label>
            <textarea id="upload-content" placeholder="Describe the changes..." class="form-input form-textarea"></textarea>
          </div>
          
          <div class="form-group" style="display: flex; gap: 20px; align-items: center;">
            <label style="margin-bottom: 0;">
              <input id="upload-critical" type="checkbox"> Critical Update
            </label>
          </div>

          <div class="form-group">
            <label>Select Update File</label>
            <input id="update-file" type="file" class="form-input">
          </div>
          
          <div id="upload-status" style="margin-bottom: 15px; font-size: 0.9em;"></div>
          <button id="upload-to-r2" class="btn" style="width: 100%; background: linear-gradient(135deg, #d946ef, #06b6d4);">â˜ï¸ Upload to R2 Storage</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    
    // Helper function to sign AWS requests (S3/R2 compatible)
    async function signRequest(method, url, headers, body, credentials) {
      const encoder = new TextEncoder();
      
      async function hmacSha256(key, message) {
        const cryptoKey = await crypto.subtle.importKey(
          "raw", key, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
        );
        return new Uint8Array(await crypto.subtle.sign("HMAC", cryptoKey, encoder.encode(message)));
      }
      
      async function sha256(message) {
        const hash = await crypto.subtle.digest("SHA-256", typeof message === "string" ? encoder.encode(message) : message);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
      }
      
      const urlObj = new URL(url);
      const datetime = new Date().toISOString().replace(/[:-]|\.\d{3}/g, "");
      const date = datetime.slice(0, 8);
      const host = urlObj.host;
      const region = "auto";
      const service = "s3";
      
      const payloadHash = await sha256(body || "");
      
      const canonicalHeaders = `host:${host}\nx-amz-content-sha256:${payloadHash}\nx-amz-date:${datetime}\n`;
      const signedHeaders = "host;x-amz-content-sha256;x-amz-date";
      
      const canonicalRequest = [
        method,
        urlObj.pathname,
        urlObj.search.slice(1),
        canonicalHeaders,
        signedHeaders,
        payloadHash
      ].join("\n");
      
      const scope = `${date}/${region}/${service}/aws4_request`;
      const stringToSign = [
        "AWS4-HMAC-SHA256",
        datetime,
        scope,
        await sha256(canonicalRequest)
      ].join("\n");
      
      let key = encoder.encode("AWS4" + credentials.secretAccessKey);
      key = await hmacSha256(key, date);
      key = await hmacSha256(key, region);
      key = await hmacSha256(key, service);
      key = await hmacSha256(key, "aws4_request");
      
      const signature = Array.from(await hmacSha256(key, stringToSign))
        .map(b => b.toString(16).padStart(2, "0")).join("");
      
      return {
        "x-amz-date": datetime,
        "x-amz-content-sha256": payloadHash,
        "Authorization": `AWS4-HMAC-SHA256 Credential=${credentials.accessKeyId}/${scope}, SignedHeaders=${signedHeaders}, Signature=${signature}`
      };
    }

    const SUPABASE_URL = "https://rgigtqpesabuyaumibaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnaWd0cXBlc2FidXlhdW1pYmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTA2OTcsImV4cCI6MjA4NDMyNjY5N30.MaMvKpVPqCQONsNaYifkSvVFmYbT5c4HYpi_qieN4H0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById("admin-status");
    const contentEl = document.getElementById("admin-content");
    const listEl = document.getElementById("announcements-list");
    const aiProviderEl = document.getElementById("ai-provider");
    const aiModelEl = document.getElementById("ai-model");
    const r2AccountIdEl = document.getElementById("r2-account-id");
    const r2AccessKeyEl = document.getElementById("r2-access-key");
    const r2SecretKeyEl = document.getElementById("r2-secret-key");
    const r2BucketNameEl = document.getElementById("r2-bucket-name");
    const r2PublicUrlEl = document.getElementById("r2-public-url");

    async function checkAdmin() {
      try {
        console.log("Checking admin status...");
        statusEl.textContent = "ğŸ” Verifying permissions...";
        
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        console.log("User check:", user ? `Logged in as ${user.email}` : "Not logged in", userError);
        
        if (userError) {
          console.error("Auth error:", userError);
          statusEl.textContent = "âš ï¸ Auth error: " + userError.message;
          statusEl.className = "auth-status error";
          setTimeout(() => window.location.href = "account.html", 2000);
          return;
        }
        
        if (!user) {
          console.log("No user found, redirecting to login...");
          statusEl.textContent = "âš ï¸ Not logged in. Redirecting...";
          setTimeout(() => window.location.href = "account.html", 1000);
          return;
        }

        statusEl.textContent = `ğŸ” Checking admin rights for ${user.email}...`;
        
        const { data: profile, error: profileError } = await supabase
          .from("profiles")
          .select("is_admin")
          .eq("id", user.id)
          .single();

        console.log("Profile check:", profile, "Error:", profileError);

        if (profileError) {
          console.error("Profile error:", profileError);
          statusEl.textContent = "âš ï¸ Error checking profile: " + profileError.message;
          statusEl.className = "auth-status error";
          return;
        }
        
        if (!profile?.is_admin) {
          console.log("User is not admin");
          statusEl.textContent = "âŒ Access Denied: You are not an admin.";
          statusEl.className = "auth-status error";
          return;
        }

        console.log("Admin access granted!");
        statusEl.textContent = "âœ… Admin Access Granted";
        statusEl.className = "auth-status success";
        contentEl.classList.remove("hidden");
        
        loadAnnouncements();
        loadAIConfig();
        loadR2Config();
        loadVersions();
        loadBetaSignups();
        loadUsers();
      } catch (err) {
        console.error("Unexpected error in checkAdmin:", err);
        statusEl.textContent = "âŒ Unexpected error: " + err.message;
        statusEl.className = "auth-status error";
      }
    }

    async function loadVersions() {
      try {
        console.log("Loading versions...");
        const listEl = document.getElementById("versions-list");
        
        const { data, error } = await supabase
          .from("r2_versions")
          .select("*")
          .order("created_at", { ascending: false });

        console.log("Versions loaded:", data, "Error:", error);

        if (error) {
          console.error("Error loading versions:", error);
          listEl.innerHTML = `<p style="color: var(--error);">Error loading versions: ${error.message}</p>`;
          return;
        }

        if (!data || data.length === 0) {
          listEl.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 30px;">No versions uploaded yet. Go to Storage tab to upload your first version.</p>`;
          return;
        }

      listEl.innerHTML = data.map(ver => `
        <div class="announcement-item" style="flex-direction: column; align-items: flex-start; gap: 15px;">
          <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
            <div class="announcement-info" style="flex: 1;">
              <h4 style="display: flex; align-items: center; gap: 10px;">
                v${ver.version}: ${ver.title}
                ${ver.is_critical ? '<span class="badge badge-critical">CRITICAL</span>' : ''}
                ${ver.is_active ? '<span class="badge badge-active">ACTIVE</span>' : '<span class="badge" style="background: #2d1b4e;">INACTIVE</span>'}
              </h4>
              <p>${ver.content ? ver.content.substring(0, 100) : 'No changelog'}${ver.content && ver.content.length > 100 ? '...' : ''}</p>
              <p style="font-size: 0.85em; color: #6b7280; margin-top: 5px;">
                ğŸ“¦ ${ver.file_name} â€¢ Uploaded: ${new Date(ver.created_at).toLocaleDateString()}
              </p>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
              <input type="radio" name="active-version" value="${ver.id}" ${ver.is_active ? 'checked' : ''} 
                onchange="setActiveVersion('${ver.id}')" 
                style="width: 20px; height: 20px; cursor: pointer;">
              <span style="color: #22c55e; font-weight: 600;">Set as Active</span>
            </label>
          </div>
          <div style="display: flex; gap: 10px; width: 100%;">
            <a href="${ver.download_url}" target="_blank" class="btn btn-outline" style="border-color: #06b6d4; color: #06b6d4; padding: 8px 16px; font-size: 0.85em; text-decoration: none;">
              â¬‡ï¸ Download
            </a>
            <button class="btn btn-outline delete-version-btn" data-id="${ver.id}" style="border-color: #ff4444; color: #ff4444; padding: 8px 16px; font-size: 0.85em;">
              ğŸ—‘ï¸ Delete
            </button>
          </div>
        </div>
      `).join("");

      // Add delete handlers
      document.querySelectorAll(".delete-version-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Are you sure you want to delete this version?")) return;
          
          const { error } = await supabase.from("r2_versions").delete().eq("id", id);
          if (error) {
            alert("Error deleting: " + error.message);
          } else {
            loadVersions();
          }
        });
      });
    } catch (err) {
      console.error("Error in loadVersions:", err);
      document.getElementById("versions-list").innerHTML = 
        `<p style="color: var(--error);">Unexpected error: ${err.message}</p>`;
    }
  }

    window.setActiveVersion = async function(versionId) {
      // First, deactivate all versions
      await supabase
        .from("r2_versions")
        .update({ is_active: false })
        .neq("id", "00000000-0000-0000-0000-000000000000");
      
      // Then activate the selected one
      const { error } = await supabase
        .from("r2_versions")
        .update({ is_active: true })
        .eq("id", versionId);

      if (error) {
        alert("Error setting active version: " + error.message);
      } else {
        // Reload to reflect changes
        loadVersions();
        
        // Also update announcement to match
        const { data: version } = await supabase
          .from("r2_versions")
          .select("*")
          .eq("id", versionId)
          .single();
        
        if (version) {
          // Deactivate old announcements
          await supabase
            .from("announcements")
            .update({ active: false })
            .neq("id", "00000000-0000-0000-0000-000000000000");
          
          // Create/update announcement for this version
          await supabase.from("announcements").upsert({
            version: version.version,
            title: version.title,
            content: version.content,
            download_url: version.download_url,
            is_critical: version.is_critical,
            active: true
          }, { onConflict: "version" });
          
          alert(`Version ${version.version} is now active!`);
        }
      }
    };

    async function loadR2Config() {
      try {
        console.log("Loading R2 config...");
        const { data, error } = await supabase
          .from("system_config")
          .select("value")
          .eq("key", "r2_storage_config")
          .single();

        console.log("R2 config loaded:", data ? "Found" : "Not found", "Error:", error);

        if (error && error.code !== 'PGRST116') {
          // PGRST116 = no rows returned, which is fine (config not set yet)
          console.error("Error loading R2 config:", error);
        }

        if (data) {
          r2AccountIdEl.value = data.value.account_id || "";
          r2AccessKeyEl.value = data.value.access_key || "";
          r2SecretKeyEl.value = data.value.secret_key || "";
          r2BucketNameEl.value = data.value.bucket_name || "";
          r2PublicUrlEl.value = data.value.public_url || "";
        }
      } catch (err) {
        console.error("Unexpected error in loadR2Config:", err);
      }
    }

    async function loadAIConfig() {
      try {
        console.log("Loading AI config...");
        const { data, error } = await supabase
          .from("system_config")
          .select("value")
          .eq("key", "builtin_ai_provider")
          .single();

        console.log("AI config loaded:", data ? "Found" : "Not found", "Error:", error);

        if (error && error.code !== 'PGRST116') {
          console.error("Error loading AI config:", error);
        }

        if (data) {
          aiProviderEl.value = data.value.provider;
          aiModelEl.value = data.value.model;
        }
      } catch (err) {
        console.error("Unexpected error in loadAIConfig:", err);
      }
    }

    async function loadAnnouncements() {
      try {
        console.log("Loading announcements...");
        const { data, error } = await supabase
          .from("announcements")
          .select("*")
          .order("created_at", { ascending: false });

        console.log("Announcements loaded:", data ? `${data.length} found` : "None", "Error:", error);

        if (error) {
          console.error("Error loading announcements:", error);
          listEl.textContent = "Error loading announcements: " + error.message;
          return;
        }

        if (!data || data.length === 0) {
          listEl.textContent = "No announcements found.";
          return;
        }

      listEl.innerHTML = data.map(ann => `
        <div class="announcement-item">
          <div class="announcement-info">
            <h4>v${ann.version}: ${ann.title} 
              ${ann.is_critical ? '<span class="badge badge-critical">CRITICAL</span>' : ''}
              ${ann.active ? '<span class="badge badge-active">ACTIVE</span>' : ''}
            </h4>
            <p>${ann.content.substring(0, 100)}${ann.content.length > 100 ? '...' : ''}</p>
          </div>
          <button class="btn btn-outline delete-btn" data-id="${ann.id}" style="border-color: #ff4444; color: #ff4444; padding: 5px 10px; font-size: 0.8em;">Delete</button>
        </div>
      `).join("");

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Are you sure you want to delete this announcement?")) return;
          
          const { error } = await supabase.from("announcements").delete().eq("id", id);
          if (error) alert("Error deleting: " + error.message);
          else loadAnnouncements();
        });
      });
    } catch (err) {
      console.error("Unexpected error in loadAnnouncements:", err);
      listEl.textContent = "Unexpected error: " + err.message;
    }
  }

    document.getElementById("save-announcement").addEventListener("click", async () => {
      const version = document.getElementById("manual-version").value.trim();
      const title = document.getElementById("manual-title").value.trim();
      const content = document.getElementById("manual-content").value.trim();
      const url = document.getElementById("manual-url").value.trim();
      const is_critical = document.getElementById("manual-critical").checked;
      const active = document.getElementById("manual-active").checked;

      if (!version || !title || !content) {
        alert("Please fill in version, title, and content.");
        return;
      }

      const { error } = await supabase.from("announcements").insert([{
        version, title, content, download_url: url, is_critical, active
      }]);

      if (error) {
        alert("Error saving: " + error.message);
      } else {
        alert("Announcement posted!");
        // Clear form
        document.getElementById("manual-version").value = "";
        document.getElementById("manual-title").value = "";
        document.getElementById("manual-content").value = "";
        document.getElementById("manual-url").value = "";
        loadAnnouncements();
      }
    });

    // Tab switching logic
    document.querySelectorAll(".nav-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        // Remove active class from all tabs and contents
        document.querySelectorAll(".nav-tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add("active");
        const tabId = `tab-${tab.dataset.tab}`;
        document.getElementById(tabId).classList.add("active");
      });
    });

    document.getElementById("save-r2-config").addEventListener("click", async () => {
      const config = {
        account_id: r2AccountIdEl.value.trim(),
        access_key: r2AccessKeyEl.value.trim(),
        secret_key: r2SecretKeyEl.value.trim(),
        bucket_name: r2BucketNameEl.value.trim(),
        public_url: r2PublicUrlEl.value.trim()
      };

      const { error } = await supabase
        .from("system_config")
        .upsert({ 
          key: "r2_storage_config", 
          value: config,
          updated_at: new Date().toISOString()
        });

      if (error) alert("Error saving R2 config: " + error.message);
      else alert("R2 Configuration saved!");
    });

    document.getElementById("upload-to-r2").addEventListener("click", async () => {
      const file = document.getElementById("update-file").files[0];
      const version = document.getElementById("upload-version").value.trim();
      const title = document.getElementById("upload-title").value.trim();
      const content = document.getElementById("upload-content").value.trim();
      const is_critical = document.getElementById("upload-critical").checked;
      const statusEl = document.getElementById("upload-status");

      if (!file || !version || !title || !content) {
        alert("Please fill in version, title, content and select a file.");
        return;
      }

      statusEl.textContent = "â³ Initializing upload...";
      statusEl.style.color = "var(--text-secondary)";

      try {
        const accountId = r2AccountIdEl.value.trim();
        const bucketName = r2BucketNameEl.value.trim();
        const credentials = {
          accessKeyId: r2AccessKeyEl.value.trim(),
          secretAccessKey: r2SecretKeyEl.value.trim(),
        };

        // 1. Read file as ArrayBuffer (browser-compatible)
        const remotePath = `updates/${version}/${file.name}`;
        statusEl.textContent = `â³ Reading ${file.name}...`;
        
        const fileBuffer = await file.arrayBuffer();
        const fileBytes = new Uint8Array(fileBuffer);
        
        statusEl.textContent = `â³ Uploading ${file.name}...`;
        
        // Build the R2 URL and sign the request
        const r2Url = `https://${bucketName}.${accountId}.r2.cloudflarestorage.com/${remotePath}`;
        const authHeaders = await signRequest("PUT", r2Url, {}, fileBytes, credentials);
        
        const uploadResponse = await fetch(r2Url, {
          method: "PUT",
          headers: {
            ...authHeaders,
            "Content-Type": file.type || "application/octet-stream",
          },
          body: fileBytes
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          throw new Error(`Upload failed: ${uploadResponse.status} - ${errorText}`);
        }

        // 2. Save version to Supabase
        statusEl.textContent = "â³ Saving version info...";
        const publicBaseUrl = r2PublicUrlEl.value.trim().replace(/\/$/, "");
        const downloadUrl = `${publicBaseUrl}/${remotePath}`;
        
        const { data: userData } = await supabase.auth.getUser();
        
        const { error: versionError } = await supabase.from("r2_versions").insert([{
          version,
          title,
          content,
          file_name: file.name,
          file_path: remotePath,
          download_url: downloadUrl,
          is_critical,
          is_active: false,
          uploaded_by: userData?.user?.id
        }]);

        if (versionError) throw versionError;

        statusEl.textContent = "âœ… Successfully uploaded to R2!";
        statusEl.style.color = "var(--success)";
        
        // Clear form
        document.getElementById("upload-version").value = "";
        document.getElementById("upload-title").value = "";
        document.getElementById("upload-content").value = "";
        document.getElementById("upload-critical").checked = false;
        document.getElementById("update-file").value = "";
        
        // Reload versions list
        loadVersions();
        
        alert("Upload complete! Go to 'Publish Update' tab to set it as active.");
        
      } catch (err) {
        console.error(err);
        statusEl.textContent = "âŒ Error: " + err.message;
        statusEl.style.color = "var(--error)";
      }
    });

    document.getElementById("update-ai-config").addEventListener("click", async () => {
      const provider = aiProviderEl.value;
      const model = aiModelEl.value.trim();

      if (!model) {
        alert("Please enter a model name.");
        return;
      }

      const { error } = await supabase
        .from("system_config")
        .upsert({ 
          key: "builtin_ai_provider", 
          value: { provider, model },
          updated_at: new Date().toISOString()
        });

      if (error) {
        alert("Error updating AI config: " + error.message);
      } else {
        alert("Global AI Engine updated! All apps will switch on next launch.");
      }
    });

    document.getElementById("generate-license").addEventListener("click", async () => {
      const email = document.getElementById("license-email").value.trim();
      let key = document.getElementById("license-key-input").value.trim();
      const duration = parseInt(document.getElementById("license-duration").value) || 30;
      const status = document.getElementById("license-status-select").value;
      const statusEl = document.getElementById("license-status");

      if (!email) {
        alert("Please enter a user email.");
        return;
      }

      if (!key) {
        // Generate a random BETA key
        const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase() + "-" + 
                          Math.random().toString(36).substring(2, 6).toUpperCase();
        key = `VIRI-BETA-${randomStr}`;
      }

      statusEl.textContent = "â³ Generating license...";
      statusEl.style.color = "var(--text-secondary)";

      try {
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + duration);

        const { error } = await supabase.from("licenses").insert([{
          license_key: key,
          email: email,
          status: status,
          expires_at: expiresAt.toISOString()
        }]);

        if (error) throw error;

        statusEl.textContent = `âœ… License generated: ${key}`;
        statusEl.style.color = "var(--success)";
        
        document.getElementById("license-email").value = "";
        document.getElementById("license-key-input").value = "";
        
        loadAdminLicenses();
        alert(`BETA License ${key} has been assigned to ${email}`);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "âŒ Error: " + err.message;
        statusEl.style.color = "var(--error)";
      }
    });

    async function loadAdminLicenses() {
      const listEl = document.getElementById("admin-licenses-list");
      const { data, error } = await supabase
        .from("licenses")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(10);

      if (error) {
        listEl.textContent = "Error loading licenses.";
        return;
      }

      if (!data || data.length === 0) {
        listEl.textContent = "No licenses found.";
        return;
      }

      listEl.innerHTML = data.map(lic => `
        <div class="announcement-item">
          <div class="announcement-info">
            <h4 style="display: flex; align-items: center; gap: 10px;">
              ${lic.license_key}
              <span class="badge ${lic.status === 'active' ? 'badge-active' : ''}" style="background: ${lic.status === 'active' ? '#22c55e' : '#4b5563'};">
                ${lic.status.toUpperCase()}
              </span>
            </h4>
            <p>ğŸ“§ ${lic.email}</p>
            <p style="font-size: 0.8em; color: #888;">Expires: ${lic.expires_at ? new Date(lic.expires_at).toLocaleDateString() : 'Never'}</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline toggle-status-btn" 
              data-key="${lic.license_key}" 
              data-status="${lic.status}"
              style="border-color: ${lic.status === 'active' ? '#f59e0b' : '#22c55e'}; color: ${lic.status === 'active' ? '#f59e0b' : '#22c55e'}; padding: 5px 10px; font-size: 0.8em;">
              ${lic.status === 'active' ? 'Deactivate' : 'Activate'}
            </button>
            <button class="btn btn-outline delete-license-btn" data-key="${lic.license_key}" style="border-color: #ff4444; color: #ff4444; padding: 5px 10px; font-size: 0.8em;">Revoke</button>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".toggle-status-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const key = btn.getAttribute("data-key");
          const currentStatus = btn.getAttribute("data-status");
          const newStatus = currentStatus === "active" ? "inactive" : "active";
          
          const { error } = await supabase
            .from("licenses")
            .update({ status: newStatus })
            .eq("license_key", key);
            
          if (error) alert("Error updating status: " + error.message);
          else loadAdminLicenses();
        });
      });

      document.querySelectorAll(".delete-license-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const key = btn.getAttribute("data-key");
          if (!confirm(`Revoke license ${key}?`)) return;
          const { error } = await supabase.from("licenses").delete().eq("license_key", key);
          if (error) alert(error.message);
          else loadAdminLicenses();
        });
      });
    }

    // â”€â”€ Beta Signups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadBetaSignups() {
      const listEl = document.getElementById("beta-signups-list");
      const filter = document.getElementById("beta-filter").value;
      listEl.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-secondary);">Loading...</div>`;

      let query = supabase
        .from("beta_signups")
        .select("*")
        .order("created_at", { ascending: false });

      if (filter !== "all") query = query.eq("status", filter);

      const { data, error } = await query;

      if (error) {
        listEl.innerHTML = `<p style="color:var(--error);">Error loading signups: ${error.message}</p>`;
        return;
      }

      // Update pending badge
      const { count } = await supabase
        .from("beta_signups")
        .select("id", { count: "exact", head: true })
        .eq("status", "pending");
      const badge = document.getElementById("beta-signups-badge");
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = "inline-block";
      } else {
        badge.style.display = "none";
      }

      if (!data || data.length === 0) {
        listEl.innerHTML = `<p style="text-align:center;color:var(--text-secondary);padding:30px;">No ${filter === "all" ? "" : filter + " "}signups found.</p>`;
        return;
      }

      const statusColors = { pending: "#f59e0b", approved: "#22c55e", rejected: "#ef4444" };

      listEl.innerHTML = data.map(s => `
        <div class="announcement-item" style="flex-direction:column; align-items:flex-start; gap:12px;" data-id="${s.id}">
          <div style="display:flex; justify-content:space-between; width:100%; align-items:flex-start; gap:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <h4 style="margin:0; display:flex; align-items:center; gap:8px;">
                ${s.name}
                <span class="badge" style="background:${statusColors[s.status] || "#4b5563"};">${s.status.toUpperCase()}</span>
              </h4>
              <p style="margin:4px 0 0; font-size:0.9em;">ğŸ“§ ${s.email}</p>
              <p style="margin:2px 0 0; font-size:0.9em; color:#06b6d4;">ğŸ® ${s.twitch_username}</p>
              ${s.content_type ? `<p style="margin:2px 0 0; font-size:0.85em; color:#a1a1aa;">ğŸ“º ${s.content_type}</p>` : ""}
              ${s.message ? `<p style="margin:6px 0 0; font-size:0.85em; color:#d1d5db; background:#1a112e; padding:8px; border-radius:6px; white-space:pre-wrap;">${s.message}</p>` : ""}
              <p style="margin:4px 0 0; font-size:0.8em; color:#6b7280;">Signed up: ${new Date(s.created_at).toLocaleString()}</p>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; min-width:140px;">
              ${s.status === "pending" ? `
                <button class="btn approve-btn" data-id="${s.id}" data-email="${s.email}" data-name="${s.name}"
                  style="background:linear-gradient(135deg,#22c55e,#06b6d4); padding:8px 14px; font-size:0.85em;">
                  âœ… Approve & Send Key
                </button>
                <button class="btn reject-btn" data-id="${s.id}"
                  style="background:transparent; border:1px solid #ef4444; color:#ef4444; padding:8px 14px; font-size:0.85em;">
                  âŒ Reject
                </button>
              ` : ""}
              ${s.status === "approved" ? `
                <button class="btn revert-btn" data-id="${s.id}"
                  style="background:transparent; border:1px solid #f59e0b; color:#f59e0b; padding:8px 14px; font-size:0.85em;">
                  â†© Revert to Pending
                </button>
              ` : ""}
              ${s.status === "rejected" ? `
                <button class="btn revert-btn" data-id="${s.id}"
                  style="background:transparent; border:1px solid #f59e0b; color:#f59e0b; padding:8px 14px; font-size:0.85em;">
                  â†© Revert to Pending
                </button>
              ` : ""}
            </div>
          </div>
        </div>
      `).join("");

      // Approve: generate license key and update status
      document.querySelectorAll(".approve-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const email = btn.getAttribute("data-email");
          const name = btn.getAttribute("data-name");

          if (!confirm(`Approve ${name} (${email}) and send them a license key?`)) return;
          btn.disabled = true;
          btn.textContent = "â³ Processing...";

          const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase() + "-" +
                            Math.random().toString(36).substring(2, 6).toUpperCase();
          const key = `VIRI-BETA-${randomStr}`;
          const expiresAt = new Date();
          expiresAt.setDate(expiresAt.getDate() + 30);

          const { error: licErr } = await supabase.from("licenses").insert([{
            license_key: key,
            email: email,
            status: "active",
            expires_at: expiresAt.toISOString()
          }]);

          if (licErr) {
            alert("Error creating license: " + licErr.message);
            btn.disabled = false;
            btn.textContent = "âœ… Approve & Send Key";
            return;
          }

          const { error: upErr } = await supabase
            .from("beta_signups")
            .update({ status: "approved" })
            .eq("id", id);

          if (upErr) {
            alert("License created but failed to update signup status: " + upErr.message);
          }

          // Send invite / magic link via Supabase built-in email
          btn.textContent = "ğŸ“§ Sending email...";
          try {
            const emailRes = await fetch(
              `${SUPABASE_URL}/functions/v1/send-beta-approval`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  name,
                  email,
                  license_key: key,
                  expires_at: expiresAt.toISOString(),
                }),
              }
            );
            const emailData = await emailRes.json();
            if (!emailRes.ok) {
              alert(`âš ï¸ License created but email failed: ${emailData.error}\n\nManually share:\nKey: ${key}\nAccount page: ${SUPABASE_URL.replace("https://rgigtqpesabuyaumibaj.supabase.co","https://viritts.com")}/account.html`);
            } else if (emailData.already_exists) {
              // User already has an account â€” show magic link for them to sign in
              const link = emailData.action_link || "https://viritts.com/account.html";
              alert(`âœ… Approved! User already has an account.\n\nLicense: ${key}\nEmail: ${email}\n\nShare this sign-in link with them:\n${link}`);
            } else {
              alert(`âœ… Approved & invite sent!\n\nLicense: ${key}\nInvite emailed to: ${email}\nExpires: ${expiresAt.toLocaleDateString()}\n\nThey'll get a Supabase invite email with a link to create their account. Their key will be waiting for them when they log in.`);
            }
          } catch (emailErr) {
            alert(`âš ï¸ License created but invite failed to send.\n\nManually share:\nKey: ${key}\nCreate account: https://viritts.com/account.html`);
          }

          loadBetaSignups();
          loadAdminLicenses();
        });
      });

      // Reject
      document.querySelectorAll(".reject-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Reject this signup?")) return;
          const { error } = await supabase.from("beta_signups").update({ status: "rejected" }).eq("id", id);
          if (error) alert("Error: " + error.message);
          else loadBetaSignups();
        });
      });

      // Revert to pending
      document.querySelectorAll(".revert-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const { error } = await supabase.from("beta_signups").update({ status: "pending" }).eq("id", id);
          if (error) alert("Error: " + error.message);
          else loadBetaSignups();
        });
      });
    }

    document.getElementById("beta-filter").addEventListener("change", loadBetaSignups);
    document.getElementById("refresh-signups").addEventListener("click", loadBetaSignups);

    // â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function callAdminUsers(action, payload = {}) {
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData?.session?.access_token;
      if (!token) throw new Error("Not authenticated");

      const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-users`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
          "apikey": SUPABASE_ANON_KEY,
        },
        body: JSON.stringify({ action, ...payload }),
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data?.error || `Request failed (${response.status})`);
      }
      return data;
    }

    async function loadUsers() {
      const listEl = document.getElementById("users-list");
      const search = (document.getElementById("users-search").value || "").trim().toLowerCase();
      listEl.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-secondary);">Loading users...</div>`;

      try {
        const res = await callAdminUsers("list", { limit: 200 });
        let users = Array.isArray(res.users) ? res.users : [];
        if (search) {
          users = users.filter(u => String(u.email || "").toLowerCase().includes(search));
        }

        if (!users.length) {
          listEl.innerHTML = `<p style="text-align:center;color:var(--text-secondary);padding:30px;">No users found.</p>`;
          return;
        }

        listEl.innerHTML = users.map((u) => `
          <div class="announcement-item" style="flex-direction:column; align-items:flex-start; gap:10px;">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:flex-start; gap:10px; flex-wrap:wrap;">
              <div style="flex:1; min-width:260px;">
                <h4 style="margin:0; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                  ${u.email || "Unknown Email"}
                  ${u.is_admin ? '<span class="badge badge-critical" style="background:#06b6d4;">ADMIN</span>' : ""}
                </h4>
                <p style="margin:4px 0 0; font-size:0.9em;">User ID: <code>${u.id}</code></p>
                ${u.twitch_username ? `<p style="margin:2px 0 0; font-size:0.9em; color:#06b6d4;">ğŸ® ${u.twitch_username}</p>` : ""}
                <p style="margin:2px 0 0; font-size:0.85em; color:#a1a1aa;">
                  Licenses: ${u.license_count || 0} (${u.active_license_count || 0} active) â€¢ Beta status: ${u.beta_status || "none"}
                </p>
                <p style="margin:2px 0 0; font-size:0.8em; color:#6b7280;">
                  Created: ${u.created_at ? new Date(u.created_at).toLocaleString() : "unknown"} â€¢ Last sign-in: ${u.last_sign_in_at ? new Date(u.last_sign_in_at).toLocaleString() : "never"}
                </p>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn btn-outline delete-user-btn" data-id="${u.id}" data-email="${u.email || ""}" style="border-color:#ef4444;color:#ef4444;padding:8px 14px;font-size:0.85em;">
                  ğŸ—‘ Delete User
                </button>
              </div>
            </div>
          </div>
        `).join("");

        document.querySelectorAll(".delete-user-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const userId = btn.getAttribute("data-id");
            const email = btn.getAttribute("data-email");
            if (!confirm(`Delete user ${email}?\n\nThis removes auth account, profile, licenses, purchases, token usage, and beta signup records.`)) return;
            if (!confirm(`Final confirm: permanently delete ${email}? This cannot be undone.`)) return;

            btn.disabled = true;
            btn.textContent = "â³ Deleting...";
            try {
              const result = await callAdminUsers("delete", { user_id: userId, email });
              alert(`âœ… User deleted.\n\nRemoved auth: ${result.deleted_auth ? "yes" : "no"}\nDeleted records for: ${email}`);
              await loadUsers();
              loadAdminLicenses();
              loadBetaSignups();
            } catch (e) {
              alert(`âŒ Failed to delete user: ${e.message}`);
              btn.disabled = false;
              btn.textContent = "ğŸ—‘ Delete User";
            }
          });
        });
      } catch (err) {
        listEl.innerHTML = `<p style="color:var(--error);">Error loading users: ${err.message}</p>`;
      }
    }

    document.getElementById("refresh-users").addEventListener("click", loadUsers);
    document.getElementById("users-search").addEventListener("input", () => {
      loadUsers();
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    checkAdmin();
    loadAdminLicenses();
  </script>
</body>
</html>
