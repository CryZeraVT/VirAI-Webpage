<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViriTTS - Account</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€ Account page overrides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .account-wrap {
      max-width: 520px;
      margin: 0 auto;
      padding: 40px 16px 80px;
    }

    .account-card {
      background: rgba(15, 5, 30, 0.85);
      border: 1px solid rgba(124, 58, 237, 0.25);
      border-radius: 18px;
      padding: 36px 32px;
      backdrop-filter: blur(16px);
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    }

    .account-card h2 {
      font-size: 1.6rem;
      font-weight: 800;
      margin: 0 0 4px;
      background: linear-gradient(135deg, #a78bfa, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .account-card .subtitle {
      color: #9ca3af;
      font-size: 0.9rem;
      margin: 0 0 24px;
    }

    /* â”€â”€ Status banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-bar {
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.88rem;
      font-weight: 500;
      margin-bottom: 18px;
      display: none;
    }
    .status-bar.show { display: block; }
    .status-bar.success { background: rgba(34,197,94,0.12); color: #4ade80; border: 1px solid rgba(34,197,94,0.25); }
    .status-bar.error   { background: rgba(239,68,68,0.12);  color: #f87171; border: 1px solid rgba(239,68,68,0.25); }
    .status-bar.info    { background: rgba(6,182,212,0.10);  color: #67e8f9; border: 1px solid rgba(6,182,212,0.22); }

    /* â”€â”€ Signed-in header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .signed-in-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .signed-in-header .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .avatar-circle {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed, #06b6d4);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 1rem; color: white;
      flex-shrink: 0;
    }
    .signed-in-header .email-label {
      font-size: 0.9rem;
      color: #e2e8f0;
      font-weight: 600;
    }
    .signed-in-header .role-badge {
      font-size: 0.72rem;
      background: rgba(6,182,212,0.15);
      color: #06b6d4;
      border: 1px solid rgba(6,182,212,0.3);
      border-radius: 20px;
      padding: 2px 8px;
    }

    /* â”€â”€ Form fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .field-group { margin-bottom: 14px; }
    .field-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: #9ca3af;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .field-group input {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(124,58,237,0.25);
      border-radius: 8px;
      padding: 10px 14px;
      color: #e2e8f0;
      font-size: 0.95rem;
      box-sizing: border-box;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    .field-group input:focus {
      outline: none;
      border-color: rgba(167,139,250,0.6);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      flex-wrap: wrap;
    }
    .btn-row .btn { flex: 1; min-width: 120px; text-align: center; }

    .divider {
      border: none;
      border-top: 1px solid rgba(124,58,237,0.2);
      margin: 28px 0;
    }

    /* â”€â”€ Reset / invite panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reset-panel {
      background: rgba(124,58,237,0.08);
      border: 1px solid rgba(124,58,237,0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .reset-panel h3 {
      margin: 0 0 14px;
      font-size: 1rem;
      color: #a78bfa;
    }

    /* â”€â”€ License cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .license-section h3 {
      font-size: 1rem;
      font-weight: 700;
      color: #e2e8f0;
      margin: 0 0 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .license-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(124,58,237,0.2);
      border-radius: 12px;
      padding: 18px 20px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }
    .license-card:hover { border-color: rgba(167,139,250,0.4); }

    .license-card .lc-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .license-key-display {
      font-family: "Courier New", monospace;
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: #a78bfa;
      word-break: break-all;
    }

    .license-status-badge {
      font-size: 0.75rem;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 20px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .badge-active   { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3); }
    .badge-inactive { background: rgba(239,68,68,0.12); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
    .badge-expired  { background: rgba(107,114,128,0.2); color: #9ca3af; border: 1px solid rgba(107,114,128,0.3); }

    .license-meta {
      margin-top: 8px;
      font-size: 0.82rem;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .license-meta span { display: flex; align-items: center; gap: 4px; }

    .license-actions {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .license-actions .btn {
      font-size: 0.82rem;
      padding: 7px 14px;
    }
    .btn-danger { border-color: #ef4444 !important; color: #ef4444 !important; }

    .empty-state {
      text-align: center;
      padding: 32px 0;
      color: #4b5563;
      font-size: 0.9rem;
    }
    .empty-state .empty-icon { font-size: 2rem; margin-bottom: 8px; }

    .text-link {
      background: none;
      border: none;
      color: #a78bfa;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 0;
      text-decoration: underline;
      font-family: inherit;
    }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeSlideOut {
      from { opacity: 1; transform: translateY(0); }
      to   { opacity: 0; transform: translateY(-10px); }
    }
    @keyframes statusSlide {
      from { opacity: 0; transform: translateY(-6px); max-height: 0; padding-top: 0; padding-bottom: 0; margin-bottom: 0; }
      to   { opacity: 1; transform: translateY(0);   max-height: 80px; padding-top: 10px; padding-bottom: 10px; margin-bottom: 18px; }
    }
    @keyframes cardPop {
      from { opacity: 0; transform: translateY(24px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0)    scale(1); }
    }
    @keyframes avatarPop {
      0%   { transform: scale(0.5); opacity: 0; }
      70%  { transform: scale(1.1); }
      100% { transform: scale(1);   opacity: 1; }
    }
    @keyframes shimmer {
      0%   { background-position: -200% center; }
      100% { background-position:  200% center; }
    }
    @keyframes licensePulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(167,139,250,0); }
      50%      { box-shadow: 0 0 0 4px rgba(167,139,250,0.12); }
    }

    .account-card {
      animation: cardPop 0.45s cubic-bezier(0.34,1.56,0.64,1) both;
    }

    /* View transitions */
    .view-enter {
      animation: fadeSlideIn 0.3s cubic-bezier(0.22,1,0.36,1) both;
    }
    .view-exit {
      animation: fadeSlideOut 0.18s ease-in both;
      pointer-events: none;
    }

    /* Status bar animation */
    .status-bar.show {
      animation: statusSlide 0.25s ease both;
      overflow: hidden;
    }

    /* Avatar entrance */
    .avatar-circle {
      animation: avatarPop 0.4s cubic-bezier(0.34,1.56,0.64,1) 0.1s both;
    }

    /* Shimmer on license key */
    .license-key-display {
      background: linear-gradient(90deg, #a78bfa 0%, #e2e8f0 40%, #a78bfa 60%, #06b6d4 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 4s linear infinite;
    }

    /* License card entrance (staggered) */
    .license-card {
      animation: fadeSlideIn 0.32s cubic-bezier(0.22,1,0.36,1) both;
    }
    .license-card:nth-child(1) { animation-delay: 0.05s; }
    .license-card:nth-child(2) { animation-delay: 0.12s; }
    .license-card:nth-child(3) { animation-delay: 0.19s; }
    .license-card:nth-child(4) { animation-delay: 0.26s; }

    /* Active license subtle pulse */
    .license-card.active-license {
      animation: fadeSlideIn 0.32s cubic-bezier(0.22,1,0.36,1) both,
                 licensePulse 3s ease-in-out 0.8s infinite;
    }

    /* Button hover lift */
    .btn {
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease !important;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(124,58,237,0.25);
    }
    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    /* Input focus glow */
    .field-group input {
      transition: border-color 0.2s, box-shadow 0.2s !important;
    }
    .field-group input:focus {
      box-shadow: 0 0 0 3px rgba(167,139,250,0.15);
    }

    /* Text link hover */
    .text-link {
      transition: color 0.15s ease;
    }
    .text-link:hover { color: #c4b5fd; }

    /* Sections visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="interactive-bg"></div>

  <div class="container">
    <header>
      <a href="index.html" class="logo">
        <img src="images/Viritts1.png" alt="ViriTTS Logo Icon" style="height:50px;">
        <img src="images/virittstextonly.png" alt="ViriTTS Text Logo" style="height:40px;">
      </a>
      <nav>
        <a href="index.html#features">Features</a>
        <a href="index.html#pricing">Pricing</a>
        <a href="index.html#about">About Me</a>
        <a href="account.html">Account</a>
        <a href="changelog.html">What's New</a>
      </nav>
    </header>

    <div class="account-wrap">
      <div class="account-card">

        <!-- Status bar -->
        <div class="status-bar" id="auth-status"></div>

        <!-- â”€â”€ Signed OUT view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="view-signed-out">

          <!-- Sign In mode (default) -->
          <div id="mode-signin">
            <h2>Welcome Back</h2>
            <p class="subtitle">Sign in to view your ViriTTS license.</p>

            <div class="field-group">
              <label>Email</label>
              <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
            </div>
            <div class="field-group">
              <label>Password</label>
              <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
            </div>

            <button id="sign-in" class="btn" style="width:100%;margin-top:4px;">Sign In</button>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;font-size:0.85rem;">
              <button class="text-link" id="reset-password">Forgot password?</button>
              <button class="text-link" id="goto-signup">No account? Sign up â†’</button>
            </div>

            <p style="font-size:0.78rem;color:#4b5563;margin-top:16px;text-align:center;line-height:1.5;">
              Beta users: use the email you applied with.<br>Check your inbox for the account setup link.
            </p>
          </div>

          <!-- Create Account mode -->
          <div id="mode-signup" class="hidden">
            <h2>Create Account</h2>
            <p class="subtitle">Set up your ViriTTS account to access your license.</p>

            <div class="field-group">
              <label>Email</label>
              <input id="signup-email" type="email" placeholder="you@example.com" autocomplete="email">
            </div>
            <div class="field-group">
              <label>Twitch Username</label>
              <input id="twitch-username" type="text" placeholder="YourTwitchName">
            </div>
            <div class="field-group">
              <label>Password</label>
              <input id="signup-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">
            </div>

            <button id="sign-up" class="btn" style="width:100%;margin-top:4px;">Create Account</button>

            <div style="text-align:center;margin-top:14px;">
              <button class="text-link" id="goto-signin">â† Back to Sign In</button>
            </div>
          </div>

        </div>

        <!-- â”€â”€ Password setup panel (recovery / invite) â”€â”€â”€â”€â”€ -->
        <div id="view-password-setup" class="hidden">
          <div class="reset-panel">
            <h3 id="reset-panel-title">Set a New Password</h3>
            <div class="field-group">
              <label>New Password</label>
              <input id="new-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div class="field-group">
              <label>Confirm Password</label>
              <input id="confirm-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button id="update-password" class="btn" style="width:100%;margin-top:4px;">Save Password</button>
          </div>
        </div>

        <!-- â”€â”€ Signed IN view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="view-signed-in" class="hidden">

          <div class="signed-in-header">
            <div class="user-info">
              <div class="avatar-circle" id="avatar-initials">?</div>
              <div>
                <div class="email-label" id="signed-in-email">â€”</div>
                <div style="font-size:0.78rem;color:#6b7280;margin-top:1px;" id="signed-in-sub">ViriTTS Beta</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <a id="admin-link" href="admin.html" class="btn btn-outline hidden" style="border-color:#06b6d4;color:#06b6d4;font-size:0.82rem;padding:7px 14px;">âš™ï¸ Admin</a>
              <button id="sign-out" class="btn btn-outline" style="font-size:0.82rem;padding:7px 14px;">Sign Out</button>
            </div>
          </div>

          <hr class="divider">

          <!-- License keys section -->
          <div class="license-section">
            <h3>ğŸ”‘ Your License Keys <button id="load-keys" class="btn btn-outline" style="font-size:0.78rem;padding:5px 12px;margin-left:auto;">Refresh</button></h3>
            <div id="keys-list">
              <div class="empty-state"><div class="empty-icon">ğŸ”‘</div>Loading your licenses...</div>
            </div>
          </div>

        </div>

      </div>

      <p style="text-align:center;font-size:0.8rem;color:#4b5563;margin-top:20px;">
        Need help? Visit <a href="https://www.viritts.com" style="color:#7c3aed;">www.viritts.com</a>
      </p>
    </div>
  </div>

  <!-- Parallax background -->
  <script>
    const bg = document.getElementById('interactive-bg');
    const particles = [];
    for (let i = 0; i < 25; i++) {
      const p = document.createElement('div');
      p.classList.add('particle');
      const size = Math.random() * 100 + 50;
      const x = Math.random() * 100;
      const y = Math.random() * 100;
      p.style.cssText = `width:${size}px;height:${size}px;left:${x}%;top:${y}%;`;
      particles.push({ el: p, x, y, speed: Math.random() * 0.05 + 0.02 });
      bg.appendChild(p);
    }
    document.addEventListener('mousemove', (e) => {
      const cx = window.innerWidth / 2, cy = window.innerHeight / 2;
      particles.forEach(p => {
        p.el.style.transform = `translate(${(e.clientX - cx) * p.speed}px, ${(e.clientY - cy) * p.speed}px)`;
      });
    });
  </script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://rgigtqpesabuyaumibaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnaWd0cXBlc2FidXlhdW1pYmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTA2OTcsImV4cCI6MjA4NDMyNjY5N30.MaMvKpVPqCQONsNaYifkSvVFmYbT5c4HYpi_qieN4H0";
    const PASSWORD_RESET_REDIRECT = "https://www.viritts.com/account.html";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $ = (id) => document.getElementById(id);

    function setStatus(msg, type = "success") {
      const el = $("auth-status");
      el.textContent = msg;
      el.className = `status-bar show ${type}`;
    }
    function clearStatus() {
      const el = $("auth-status");
      el.textContent = "";
      el.className = "status-bar";
    }

    function showView(name) {
      const views = ["view-signed-out", "view-signed-in", "view-password-setup"];
      const current = views.find(v => !$(v).classList.contains("hidden") && v !== name);

      if (current) {
        const currentEl = $(current);
        currentEl.classList.add("view-exit");
        setTimeout(() => {
          currentEl.classList.add("hidden");
          currentEl.classList.remove("view-exit");
          activateView(name);
        }, 160);
      } else {
        activateView(name);
      }
      if (name === "view-signed-out") showMode("signin");
    }

    function activateView(name) {
      ["view-signed-out", "view-signed-in", "view-password-setup"].forEach(v => {
        $(v).classList.toggle("hidden", v !== name);
      });
      const el = $(name);
      el.classList.remove("view-enter");
      void el.offsetWidth; // force reflow
      el.classList.add("view-enter");
    }

    function showMode(mode) {
      const fromEl = mode === "signin" ? $("mode-signup") : $("mode-signin");
      const toEl   = mode === "signin" ? $("mode-signin") : $("mode-signup");

      // Always ensure the target is shown, regardless of fromEl state
      if (!fromEl.classList.contains("hidden")) {
        fromEl.classList.add("view-exit");
        setTimeout(() => {
          fromEl.classList.add("hidden");
          fromEl.classList.remove("view-exit");
          toEl.classList.remove("hidden");
          toEl.classList.remove("view-enter");
          void toEl.offsetWidth;
          toEl.classList.add("view-enter");
        }, 160);
      } else {
        // fromEl already hidden â€” just show the target directly
        fromEl.classList.add("hidden"); // ensure it's truly hidden
        toEl.classList.remove("hidden");
        toEl.classList.remove("view-enter");
        void toEl.offsetWidth;
        toEl.classList.add("view-enter");
      }
    }

    function getAuthLinkTypeFromHash() {
      const hash = String(window.location.hash || "").toLowerCase();
      if (hash.includes("type=recovery")) return "recovery";
      if (hash.includes("type=invite")) return "invite";
      return "";
    }

    function enterPasswordSetupMode(mode = "recovery") {
      const titleEl = $("reset-panel-title");
      showView("view-password-setup");
      if (mode === "invite") {
        titleEl.textContent = "Create Your Password";
        setStatus("Welcome! Set your password below to finish account setup.", "info");
      } else {
        titleEl.textContent = "Set a New Password";
        setStatus("Enter your new password below.", "info");
      }
    }

    function exitPasswordSetupMode() {
      showView("view-signed-out");
      clearStatus();
    }

    // â”€â”€ Signed-in UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _enteringSignedIn = false;

    async function enterSignedIn(user, authEvent) {
      if (_enteringSignedIn) return;
      _enteringSignedIn = true;

      try {
        // Only refresh for cached sessions (INITIAL_SESSION).
        // SIGNED_IN and TOKEN_REFRESHED already have a fresh JWT.
        if (authEvent === "INITIAL_SESSION") {
          const { data: refreshed, error: refreshErr } = await supabase.auth.refreshSession();
          if (refreshErr || !refreshed?.session) {
            console.warn("Cached session expired, signing out:", refreshErr?.message);
            await supabase.auth.signOut();
            return;
          }
          user = refreshed.session.user;
        }

        // Reset UI to clean state before populating
        $("admin-link").classList.add("hidden");
        $("signed-in-sub").textContent = "ViriTTS Beta";
        $("keys-list").innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”‘</div>Loading your licenses...</div>`;

        showView("view-signed-in");
        $("signed-in-email").textContent = user.email ?? "Unknown";
        $("avatar-initials").textContent = (user.email ?? "?")[0].toUpperCase();
        clearStatus();

        const { data: profile } = await supabase
          .from("profiles")
          .select("is_admin, twitch_username")
          .eq("id", user.id)
          .maybeSingle();

        if (profile?.is_admin) {
          $("admin-link").classList.remove("hidden");
          $("signed-in-sub").textContent = "Admin Â· ViriTTS Beta";
        }
        if (profile?.twitch_username) {
          $("signed-in-sub").textContent = `ğŸ® ${profile.twitch_username}`;
        }

        await loadKeys(user);
      } catch (err) {
        console.error("enterSignedIn error:", err);
      } finally {
        _enteringSignedIn = false;
      }
    }

    // â”€â”€ Load license keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadKeys(user) {
      const keysList = $("keys-list");
      keysList.innerHTML = `<div class="empty-state"><div class="empty-icon">â³</div>Loading licenses...</div>`;

      try {
        // If no user passed in, restore from session
        if (!user) {
          const { data: sessionData } = await supabase.auth.getSession();
          user = sessionData?.session?.user ?? null;
          if (!user) {
            const { data: refreshData } = await supabase.auth.refreshSession();
            user = refreshData?.session?.user ?? null;
          }
        }
        if (!user) {
          keysList.innerHTML = `<div class="empty-state">Please sign in to view your licenses.</div>`;
          return;
        }

        let downloadUrl = null;
        try {
          const { data: versionData } = await supabase
            .from("r2_versions")
            .select("download_url, version")
            .eq("is_active", true)
            .order("created_at", { ascending: false })
            .limit(1)
            .single();
          if (versionData) downloadUrl = versionData.download_url;
        } catch (e) {
          console.warn("Could not load active version:", e);
        }

        const { data, error } = await supabase
          .from("licenses")
          .select("license_key,status,expires_at,created_at")
          .ilike("email", user.email)
          .order("created_at", { ascending: false });

        if (error) {
          keysList.innerHTML = `<div class="empty-state" style="color:#f87171;">Error loading licenses (${error.message}). Try refreshing.</div>`;
          return;
        }

        if (!data || data.length === 0) {
          keysList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ğŸ”</div>
              No licenses found for <strong style="color:#a78bfa">${user.email}</strong>.<br>
              <span style="font-size:0.8rem;">Contact support if you believe this is an error.</span>
            </div>`;
          return;
        }

      keysList.innerHTML = data.map((row) => {
        const isActive = row.status === "active";
        const isExpired = row.expires_at && new Date(row.expires_at) < new Date();
        const badgeClass = isExpired ? "badge-expired" : isActive ? "badge-active" : "badge-inactive";
        const badgeLabel = isExpired ? "EXPIRED" : row.status.toUpperCase();

        const expires = row.expires_at
          ? new Date(row.expires_at).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })
          : "No expiry";
        const created = row.created_at
          ? new Date(row.created_at).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })
          : "";

        const downloadBtn = isActive && downloadUrl
          ? `<a href="${downloadUrl}" class="btn" style="background:linear-gradient(135deg,#d946ef,#06b6d4);text-decoration:none;font-size:0.82rem;padding:7px 14px;">â¬‡ï¸ Download</a>`
          : "";

        return `
          <div class="license-card${isActive && !isExpired ? " active-license" : ""}">
            <div class="lc-top">
              <div class="license-key-display">${row.license_key}</div>
              <span class="license-status-badge ${badgeClass}">${badgeLabel}</span>
            </div>
            <div class="license-meta">
              <span>ğŸ“… Expires ${expires}</span>
              ${created ? `<span>ğŸ—“ Issued ${created}</span>` : ""}
              <span>ğŸ’» 1-PC License</span>
            </div>
            <div class="license-actions">
              ${downloadBtn}
              <button class="btn btn-outline copy-btn" data-key="${row.license_key}">ğŸ“‹ Copy Key</button>
              <button class="btn btn-outline reset-btn btn-danger" data-key="${row.license_key}">ğŸ”„ Reset PC</button>
            </div>
          </div>`;
      }).join("");

      document.querySelectorAll(".copy-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          navigator.clipboard.writeText(btn.getAttribute("data-key") || "");
          btn.textContent = "âœ… Copied!";
          setTimeout(() => (btn.textContent = "ğŸ“‹ Copy Key"), 1500);
        });
      });

      document.querySelectorAll(".reset-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const key = btn.getAttribute("data-key") || "";
          if (!confirm(`Reset machine binding for:\n${key}\n\nThis lets you activate on a new PC.`)) return;
          btn.disabled = true;
          btn.textContent = "Resetting...";
          try {
            const { data, error } = await supabase.functions.invoke("reset-license", { body: { license_key: key } });
            if (error) { alert("Error: " + (error.message || "Failed to reset")); return; }
            if (data.success) { setStatus("âœ… License reset â€” you can now activate on a new PC.", "success"); loadKeys(); }
            else alert("Error: " + data.message);
          } catch (err) {
            alert("Failed to reset. Please try again.");
          } finally {
            btn.disabled = false;
            btn.textContent = "ğŸ”„ Reset PC";
          }
        });
      });

      } catch (err) {
        console.error("loadKeys error:", err);
        keysList.innerHTML = `<div class="empty-state" style="color:#f87171;">Failed to load licenses. <button class="text-link" onclick="location.reload()">Reload page</button></div>`;
      }
    }

    // â”€â”€ Auth state machine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Single source of truth: onAuthStateChange drives everything.
    // INITIAL_SESSION fires on every page load (including back-navigation)
    // with the current session from localStorage â€” no need for a separate
    // getSession() call that races with the auth listener.

    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log("[auth]", event, session?.user?.email ?? "no user");

      if (event === "PASSWORD_RECOVERY") {
        enterPasswordSetupMode("recovery");
        return;
      }

      if (event === "SIGNED_OUT") {
        _enteringSignedIn = false;
        // Reset signed-in view to clean state for next login
        $("admin-link").classList.add("hidden");
        $("signed-in-sub").textContent = "ViriTTS Beta";
        $("keys-list").innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”‘</div>Loading your licenses...</div>`;
        showView("view-signed-out");
        clearStatus();
        return;
      }

      // INITIAL_SESSION  â†’ page load (logged in or not)
      // SIGNED_IN        â†’ after signInWithPassword / invite link
      // TOKEN_REFRESHED  â†’ silent token refresh (e.g. returning from admin)
      if (event === "INITIAL_SESSION" || event === "SIGNED_IN" || event === "TOKEN_REFRESHED") {
        const linkType = getAuthLinkTypeFromHash();
        if (linkType === "invite" && event === "SIGNED_IN") {
          enterPasswordSetupMode("invite");
          return;
        }
        if (session?.user) {
          await enterSignedIn(session.user, event);
        } else if (event === "INITIAL_SESSION") {
          // No session on first load â€” show login
          showView("view-signed-out");
        }
      }
    });

    // Handle password-reset / invite links that arrive via URL hash
    // (Supabase fires PASSWORD_RECOVERY or SIGNED_IN automatically,
    //  but we show the setup view immediately to avoid flash)
    const initialLinkType = getAuthLinkTypeFromHash();
    if (initialLinkType === "recovery") {
      enterPasswordSetupMode("recovery");
    }

    // â”€â”€ Button handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $("goto-signup").addEventListener("click", () => { clearStatus(); showMode("signup"); });
    $("goto-signin").addEventListener("click", () => { clearStatus(); showMode("signin"); });

    $("sign-in").addEventListener("click", async () => {
      const email    = $("email").value.trim();
      const password = $("password").value.trim();
      if (!email || !password) return setStatus("Enter your email and password.", "error");

      const btn = $("sign-in");
      btn.disabled    = true;
      btn.textContent = "Signing inâ€¦";
      setStatus("Signing inâ€¦", "");

      const { error } = await supabase.auth.signInWithPassword({ email, password });

      btn.disabled    = false;
      btn.textContent = "Sign In";

      if (error) return setStatus(error.message, "error");
      // onAuthStateChange SIGNED_IN will fire and call enterSignedIn
    });

    $("sign-up").addEventListener("click", async () => {
      const email = $("signup-email").value.trim();
      const twitchUsername = $("twitch-username").value.trim();
      const password = $("signup-password").value.trim();
      if (!email || !password) return setStatus("Enter email and password.", "error");
      if (!twitchUsername) return setStatus("Twitch username is required.", "error");

      const { data, error } = await supabase.auth.signUp({
        email, password,
        options: { data: { twitch_username: twitchUsername } }
      });
      if (error) {
        const msg = error.message.toLowerCase();
        if (msg.includes("already") || msg.includes("registered") || msg.includes("exists")) {
          return setStatus("Account already exists â€” sign in instead.", "error");
        }
        return setStatus(error.message, "error");
      }
      if (data?.user && (!data.user.identities || data.user.identities.length === 0)) {
        return setStatus("Account already exists â€” sign in instead.", "error");
      }
      if (data?.session) {
        setStatus("Account created and signed in.", "success");
      } else {
        setStatus("Account created! Check your email to confirm, then sign in.", "info");
      }
    });

    $("sign-out").addEventListener("click", () => {
      const btn = $("sign-out");
      btn.disabled = true;
      btn.textContent = "Signing outâ€¦";
      supabase.auth.signOut().finally(() => {
        btn.disabled = false;
        btn.textContent = "Sign Out";
        // Force view switch regardless of whether onAuthStateChange fired
        _enteringSignedIn = false;
        showView("view-signed-out");
        clearStatus();
      });
    });

    $("reset-password").addEventListener("click", async () => {
      const email = ($("email").value || "").trim();
      if (!email) return setStatus("Enter your email address above first.", "error");
      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: PASSWORD_RESET_REDIRECT });
      if (error) return setStatus(error.message, "error");
      setStatus("Password reset email sent â€” check your inbox.", "success");
    });

    $("update-password").addEventListener("click", async () => {
      const newPassword = $("new-password").value.trim();
      const confirmPassword = $("confirm-password").value.trim();
      if (!newPassword || !confirmPassword) return setStatus("Enter your new password twice.", "error");
      if (newPassword !== confirmPassword) return setStatus("Passwords don't match.", "error");
      const { error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) return setStatus(error.message, "error");
      setStatus("Password saved! Taking you to your account...", "success");
      setTimeout(() => { window.location.href = "/account.html"; }, 1400);
    });

    $("load-keys").addEventListener("click", loadKeys);
  </script>
</body>
</html>
