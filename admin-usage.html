<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ViriTTS - Token Usage Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@aws-sdk/client-s3@3.454.0/dist-browser/index.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes sidebarFade {
      from { opacity: 0; transform: translateX(-10px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    @keyframes tabIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes countUp {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* â”€â”€ Shell layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .usage-shell {
      display: flex;
      gap: 0;
      min-height: calc(100vh - 100px);
      max-width: 1300px;
      margin: 32px auto 60px;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(124,58,237,0.2);
      box-shadow: 0 12px 60px rgba(0,0,0,0.5);
      animation: fadeSlideIn 0.4s cubic-bezier(0.22,1,0.36,1) both;
    }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .usage-sidebar {
      width: 210px;
      flex-shrink: 0;
      background: rgba(10,4,24,0.97);
      border-right: 1px solid rgba(124,58,237,0.15);
      display: flex;
      flex-direction: column;
      padding: 28px 0 24px;
      animation: sidebarFade 0.4s ease both;
    }
    .sidebar-brand {
      padding: 0 20px 22px;
      border-bottom: 1px solid rgba(124,58,237,0.12);
      margin-bottom: 14px;
    }
    .sidebar-brand h2 {
      font-size: 0.95rem;
      font-weight: 800;
      margin: 0 0 2px;
      background: linear-gradient(135deg, #a78bfa, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .sidebar-brand p { font-size: 0.7rem; color: #4b5563; margin: 0; }

    .sidebar-section-label {
      font-size: 0.67rem;
      font-weight: 700;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 12px 20px 5px;
    }

    .nav-tab {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-left: 3px solid transparent;
      color: #6b7280;
      cursor: pointer;
      font-size: 0.88rem;
      font-weight: 500;
      font-family: inherit;
      width: 100%;
      text-align: left;
      transition: all 0.18s;
    }
    .nav-tab:hover:not(.active) {
      color: #a78bfa;
      background: rgba(167,139,250,0.06);
      border-left-color: rgba(167,139,250,0.3);
    }
    .nav-tab.active {
      color: #e2e8f0;
      background: rgba(124,58,237,0.12);
      border-left-color: #a78bfa;
      font-weight: 600;
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 16px 20px 0;
      border-top: 1px solid rgba(124,58,237,0.12);
    }
    .sidebar-footer a {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #7c3aed;
      text-decoration: none;
      font-size: 0.82rem;
      font-weight: 600;
      padding: 7px 0;
      transition: opacity 0.15s;
    }
    .sidebar-footer a:hover { opacity: 0.75; }
    .sidebar-footer a.green { color: #22c55e; }

    /* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .usage-main {
      flex: 1;
      background: rgba(15,5,30,0.92);
      backdrop-filter: blur(16px);
      overflow-y: auto;
    }

    /* Status wrap */
    .usage-status-wrap { padding: 40px; }

    /* Tab panels */
    .tab-content {
      display: none;
      padding: 32px 36px;
      animation: tabIn 0.25s ease both;
    }
    .tab-content.active { display: block; }

    /* Tab header */
    .tab-header {
      margin-bottom: 24px;
      padding-bottom: 18px;
      border-bottom: 1px solid rgba(124,58,237,0.15);
    }
    .tab-header h3 {
      font-size: 1.25rem;
      font-weight: 800;
      margin: 0 0 4px;
      color: #e2e8f0;
    }
    .tab-header p { font-size: 0.85rem; color: #6b7280; margin: 0; }
    .tab-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 14px;
    }

    /* â”€â”€ Date filter bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .filter-bar {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.025);
      border: 1px solid rgba(124,58,237,0.15);
      border-radius: 12px;
    }
    .filter-bar label {
      font-size: 0.78rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-right: 4px;
      white-space: nowrap;
    }
    .quick-btn {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(124,58,237,0.2);
      border-radius: 7px;
      color: #9ca3af;
      padding: 6px 13px;
      font-size: 0.82rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .quick-btn:hover { border-color: #a78bfa; color: #a78bfa; background: rgba(167,139,250,0.07); }
    .quick-btn.active { border-color: #a78bfa; color: #e2e8f0; background: rgba(124,58,237,0.18); font-weight: 600; }

    .filter-sep { width: 1px; height: 22px; background: rgba(124,58,237,0.2); margin: 0 4px; flex-shrink: 0; }

    .date-input {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(124,58,237,0.2);
      border-radius: 7px;
      padding: 6px 10px;
      color: #e2e8f0;
      font-family: inherit;
      font-size: 0.82rem;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    .date-input:focus { outline: none; border-color: rgba(167,139,250,0.5); }

    /* old time-range select kept for JS compat */
    #time-range { display: none; }

    /* â”€â”€ Stats grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(124,58,237,0.18);
      border-radius: 12px;
      padding: 18px 16px;
      text-align: center;
      transition: border-color 0.2s, transform 0.15s;
      animation: countUp 0.35s ease both;
    }
    .stat-card:hover { border-color: rgba(167,139,250,0.4); transform: translateY(-1px); }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 800;
      color: #06b6d4;
      margin: 0;
      line-height: 1.1;
    }
    .stat-value.cost { color: #22c55e; }
    .stat-delta {
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 3px;
    }
    .stat-delta.up   { color: #4ade80; }
    .stat-delta.down { color: #f87171; }
    .stat-delta.neutral { color: #6b7280; }
    .stat-label { color: #6b7280; font-size: 0.8rem; margin-top: 5px; }

    /* â”€â”€ Section sub-card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .usage-section {
      background: rgba(255,255,255,0.025);
      border: 1px solid rgba(124,58,237,0.13);
      border-radius: 12px;
      padding: 20px 22px;
      margin-bottom: 18px;
    }
    .usage-section-title {
      font-size: 0.77rem;
      font-weight: 700;
      color: #7c3aed;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      margin: 0 0 14px;
    }

    /* â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 18px;
    }
    @media (max-width: 860px) { .chart-grid { grid-template-columns: 1fr; } }
    .chart-box {
      background: rgba(255,255,255,0.025);
      border: 1px solid rgba(124,58,237,0.13);
      border-radius: 12px;
      padding: 18px 20px;
    }
    .chart-box h4 { margin: 0 0 14px; font-size: 0.88rem; color: #a78bfa; font-weight: 700; }
    .chart-wrap { position: relative; height: 190px; }

    /* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid rgba(124,58,237,0.15);
      border-radius: 10px;
    }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td {
      padding: 11px 14px;
      text-align: left;
      border-bottom: 1px solid rgba(124,58,237,0.1);
    }
    .data-table th {
      background: rgba(124,58,237,0.1);
      color: #a78bfa;
      font-weight: 700;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .data-table tr:hover td { background: rgba(167,139,250,0.05); }
    .data-table td { color: #e2e8f0; font-size: 0.88rem; }

    .section-title {
      color: #a78bfa;
      margin: 0 0 14px;
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before {
      content: '';
      width: 3px; height: 16px;
      background: linear-gradient(180deg, #a78bfa, #06b6d4);
      border-radius: 2px;
    }

    /* â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .license-key {
      font-family: monospace;
      font-size: 0.82rem;
      color: #06b6d4;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .model-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.72rem;
      font-weight: 600;
      background: rgba(6,182,212,0.15);
      color: #06b6d4;
      border: 1px solid rgba(6,182,212,0.25);
    }
    .loading { text-align: center; padding: 36px; color: #4b5563; font-size: 0.9rem; }

    .refresh-btn {
      background: transparent;
      border: 1px solid #06b6d4;
      color: #06b6d4;
      padding: 7px 14px;
      border-radius: 7px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.18s;
      white-space: nowrap;
    }
    .refresh-btn:hover { background: rgba(6,182,212,0.12); }

    /* btn tweaks */
    .btn { transition: transform 0.15s, box-shadow 0.15s !important; }
    .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124,58,237,0.25); }

    /* Projection list */
    .proj-list { list-style: none; margin: 0; padding: 0; }
    .proj-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 0;
      border-bottom: 1px solid rgba(124,58,237,0.1);
      font-size: 0.88rem;
      color: #9ca3af;
    }
    .proj-list li:last-child { border-bottom: none; }
    .proj-list .proj-val { font-weight: 700; font-size: 0.95rem; }

    /* Form inputs in pricing / plan settings */
    .form-input-sm {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(124,58,237,0.2);
      border-radius: 7px;
      padding: 7px 11px;
      color: #e2e8f0;
      font-family: inherit;
      font-size: 0.85rem;
      transition: border-color 0.2s;
    }
    .form-input-sm:focus { outline: none; border-color: rgba(167,139,250,0.5); }

    /* Responsive */
    @media (max-width: 720px) {
      .usage-shell { flex-direction: column; border-radius: 14px; }
      .usage-sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; padding: 10px; border-right: none; border-bottom: 1px solid rgba(124,58,237,0.15); }
      .sidebar-brand, .sidebar-section-label, .sidebar-footer { display: none; }
      .nav-tab { width: auto; border-left: none; border-bottom: 3px solid transparent; border-radius: 8px; padding: 7px 12px; font-size: 0.8rem; }
      .nav-tab.active { border-bottom-color: #a78bfa; background: rgba(124,58,237,0.15); }
      .tab-content { padding: 18px; }
      .chart-grid { grid-template-columns: 1fr; }
    }

    .hidden { display: none !important; }
    .auth-status { padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div id="interactive-bg"></div>

  <div class="container">
    <header>
      <a href="index.html" class="logo">
        <img src="images/Viritts1.png" alt="ViriTTS Logo Icon" style="height: 50px;">
        <img src="images/virittstextonly.png" alt="ViriTTS Text Logo" style="height: 40px;">
      </a>
      <nav>
        <a href="admin.html">Admin Dashboard</a>
        <a href="account.html">Account</a>
      </nav>
    </header>

    <!-- Status (shown while checking admin) -->
    <div id="admin-status-wrap" class="usage-status-wrap">
      <div id="admin-status" class="auth-status">Checking permissions...</div>
    </div>

    <!-- Hidden until admin confirmed -->
    <div id="admin-content" class="usage-shell hidden">

      <!-- â”€â”€ Sidebar â”€â”€ -->
      <aside class="usage-sidebar">
        <div class="sidebar-brand">
          <h2>Usage Dashboard</h2>
          <p>ViriTTS Analytics</p>
        </div>

        <span class="sidebar-section-label">Analytics</span>
        <button class="nav-tab active" data-tab="overview">ğŸ“Š Overview</button>
        <button class="nav-tab" data-tab="revenue">ğŸ’° Revenue</button>
        <button class="nav-tab" data-tab="users">ğŸ‘¤ By User</button>
        <button class="nav-tab" data-tab="daily">ğŸ“… Daily Breakdown</button>
        <button class="nav-tab" data-tab="models">ğŸ¤– By Model</button>

        <span class="sidebar-section-label" style="margin-top: 10px;">Settings</span>
        <button class="nav-tab" data-tab="costs">ğŸ’µ API Costs</button>
        <button class="nav-tab" data-tab="pricing">âš™ï¸ Pricing Config</button>

        <div class="sidebar-footer">
          <a href="admin.html">â† Admin Dashboard</a>
          <a href="#" id="sidebar-refresh" class="green">â†» Refresh All</a>
        </div>
      </aside>

      <!-- â”€â”€ Main â”€â”€ -->
      <main class="usage-main">

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             OVERVIEW TAB  (new â€“ global top-level stats)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content active" id="tab-overview">
          <div class="tab-header">
            <div class="tab-header-row">
              <div>
                <h3>ğŸ“Š Usage Overview</h3>
                <p>Top-level metrics across all users and AI models.</p>
              </div>
              <button class="refresh-btn" id="refresh-btn">â†» Refresh</button>
            </div>
          </div>

          <!-- Date filter bar -->
          <div class="filter-bar" id="filter-bar-overview">
            <label>Range:</label>
            <button class="quick-btn" data-range="today">Today</button>
            <button class="quick-btn" data-range="yesterday">Yesterday</button>
            <button class="quick-btn active" data-range="week">This Week</button>
            <button class="quick-btn" data-range="last-week">Last Week</button>
            <button class="quick-btn" data-range="month">This Month</button>
            <button class="quick-btn" data-range="last-month">Last Month</button>
            <button class="quick-btn" data-range="30d">Last 30 Days</button>
            <button class="quick-btn" data-range="all">All Time</button>
            <div class="filter-sep"></div>
            <label>Custom:</label>
            <input type="date" class="date-input" id="custom-start" title="Start date">
            <span style="color:#4b5563; font-size:0.8rem;">â€“</span>
            <input type="date" class="date-input" id="custom-end" title="End date">
            <button class="quick-btn" id="apply-custom" style="border-color:#a78bfa; color:#a78bfa;">Apply</button>
            <!-- hidden select keeps the JS logic working -->
            <select id="time-range" style="display:none;">
              <option value="today">Today</option>
              <option value="week" selected>Last 7 Days</option>
              <option value="month">Last 30 Days</option>
              <option value="all">All Time</option>
            </select>
          </div>

          <!-- Top stats -->
          <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
              <p class="stat-value" id="total-requests">-</p>
              <p class="stat-delta neutral" id="delta-requests"></p>
              <p class="stat-label">Total Requests</p>
            </div>
            <div class="stat-card">
              <p class="stat-value" id="total-tokens">-</p>
              <p class="stat-delta neutral" id="delta-tokens"></p>
              <p class="stat-label">Total Tokens</p>
            </div>
            <div class="stat-card">
              <p class="stat-value cost" id="total-cost">-</p>
              <p class="stat-delta neutral" id="delta-cost"></p>
              <p class="stat-label">Total Cost (USD)</p>
            </div>
            <div class="stat-card">
              <p class="stat-value" id="active-users">-</p>
              <p class="stat-delta neutral" id="delta-users"></p>
              <p class="stat-label">Active Users</p>
            </div>
          </div>

          <!-- Mini charts row -->
          <div class="chart-grid">
            <div class="chart-box">
              <h4>ğŸ“ˆ Daily Requests</h4>
              <div class="chart-wrap"><canvas id="overviewDailyChart"></canvas></div>
            </div>
            <div class="chart-box">
              <h4>ğŸ¤– Tokens by Model</h4>
              <div class="chart-wrap"><canvas id="overviewModelChart"></canvas></div>
            </div>
          </div>

          <!-- Top users quick view -->
          <div class="usage-section">
            <p class="usage-section-title">Top Users by Token Usage</p>
            <div class="table-container" style="max-height: 260px;">
              <table class="data-table">
                <thead><tr>
                  <th>Twitch Channel</th>
                  <th>Requests</th>
                  <th>Total Tokens</th>
                  <th>Cost (USD)</th>
                </tr></thead>
                <tbody id="overview-top-users-body">
                  <tr><td colspan="4" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             REVENUE TAB
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tab-revenue">
          <div class="tab-header">
            <div class="tab-header-row">
              <div>
                <h3 style="background: linear-gradient(135deg,#22c55e,#06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">ğŸ’° Business Metrics</h3>
                <p>Revenue, costs, and profitability breakdown.</p>
              </div>
              <button class="refresh-btn" id="refresh-revenue" style="border-color:#22c55e; color:#22c55e;">â†» Refresh</button>
            </div>
          </div>

          <div class="filter-bar">
            <label>Billing Month:</label>
            <select id="revenue-month" class="date-input" style="width:auto;">
              <option value="0">Current Month</option>
            </select>
            <span id="billing-period-text" style="color:#4b5563; font-size:0.8rem; margin-left:8px;"></span>
          </div>

          <div class="stats-grid" id="revenue-stats">
            <div class="stat-card" style="border-color:#22c55e;">
              <p class="stat-value" id="active-subs" style="color:#22c55e;">-</p>
              <p class="stat-label">Active Subscribers</p>
            </div>
            <div class="stat-card" style="border-color:#22c55e;">
              <p class="stat-value cost" id="gross-revenue">-</p>
              <p class="stat-label">Gross Revenue</p>
            </div>
            <div class="stat-card" style="border-color:#ef4444;">
              <p class="stat-value" id="api-costs" style="color:#ef4444;">-</p>
              <p class="stat-label">API Costs</p>
            </div>
            <div class="stat-card" style="border-color:#f59e0b;">
              <p class="stat-value" id="tax-reserve" style="color:#f59e0b;">-</p>
              <p class="stat-label">Tax Reserve (30%)</p>
            </div>
            <div class="stat-card" style="border-color:#22c55e; background: linear-gradient(135deg,rgba(34,197,94,0.07),transparent);">
              <p class="stat-value cost" id="net-profit" style="font-size:1.6rem;">-</p>
              <p class="stat-label">Net Profit (After Tax)</p>
            </div>
            <div class="stat-card" style="border-color:#8b5cf6;">
              <p class="stat-value" id="profit-margin" style="color:#8b5cf6;">-</p>
              <p class="stat-label">Profit Margin</p>
            </div>
            <div class="stat-card" style="border-color:#06b6d4;">
              <p class="stat-value" id="cost-per-user" style="color:#06b6d4;">-</p>
              <p class="stat-label">API Cost / User</p>
            </div>
            <div class="stat-card" style="border-color:#f59e0b;">
              <p class="stat-value" id="price-per-sub" style="color:#f59e0b;">-</p>
              <p class="stat-label">Price / Sub</p>
            </div>
          </div>

          <div class="chart-grid">
            <div class="chart-box">
              <h4>ğŸ’° Revenue Breakdown</h4>
              <div class="chart-wrap"><canvas id="revenueChart"></canvas></div>
            </div>
            <div class="chart-box">
              <h4 style="color:#06b6d4;">ğŸ“ˆ Daily API Costs</h4>
              <div class="chart-wrap"><canvas id="dailyCostsChart"></canvas></div>
            </div>
          </div>

          <div class="chart-grid">
            <div class="chart-box">
              <h4 style="color:#f59e0b;">ğŸ¤– Cost by Model</h4>
              <div class="chart-wrap"><canvas id="modelCostsChart"></canvas></div>
            </div>
            <div class="chart-box">
              <h4 style="color:#22c55e;">ğŸ“Š Monthly Projection</h4>
              <ul class="proj-list" id="projection-summary">
                <li>Current Revenue <span class="proj-val" id="proj-revenue" style="color:#22c55e;">-</span></li>
                <li>Projected API Costs <span class="proj-val" id="proj-costs" style="color:#ef4444;">-</span></li>
                <li>Tax Reserve (30%) <span class="proj-val" id="proj-tax" style="color:#f59e0b;">-</span></li>
                <li style="font-size:1rem; font-weight:700; color:#e2e8f0;">Take Home <span class="proj-val" id="proj-takehome" style="color:#22c55e; font-size:1.1rem;">-</span></li>
              </ul>
              <p style="margin: 10px 0 0; font-size:0.75rem; color:#4b5563;">Based on current daily average</p>
            </div>
          </div>

          <!-- Plan settings -->
          <div class="usage-section" style="border-color:rgba(34,197,94,0.25); background:rgba(34,197,94,0.04);">
            <p class="usage-section-title" style="color:#22c55e;">ğŸ’¡ Subscription Plan Settings</p>
            <div style="display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end;">
              <div>
                <label style="display:block; color:#6b7280; font-size:0.78rem; margin-bottom:5px;">Plan Name</label>
                <input type="text" id="plan-name" placeholder="ViriTTS Monthly" class="form-input-sm" style="width:180px;">
              </div>
              <div>
                <label style="display:block; color:#6b7280; font-size:0.78rem; margin-bottom:5px;">Monthly Price ($)</label>
                <input type="number" id="plan-price" placeholder="9.99" step="0.01" class="form-input-sm" style="width:110px;">
              </div>
              <button class="refresh-btn btn" id="save-plan" style="border-color:#22c55e; color:#22c55e;">ğŸ’¾ Update Plan</button>
            </div>
            <p id="plan-id" style="display:none;"></p>
          </div>

          <!-- Daily table -->
          <div class="usage-section">
            <p class="usage-section-title">Daily API Costs This Month</p>
            <div class="table-container" style="max-height: 240px;">
              <table class="data-table">
                <thead><tr>
                  <th>Date</th><th>Requests</th><th>Input Tokens</th><th>Output Tokens</th><th>Cost</th>
                </tr></thead>
                <tbody id="revenue-daily-body">
                  <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             BY USER TAB
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tab-users">
          <div class="tab-header">
            <h3>ğŸ‘¤ Usage by User</h3>
            <p>Token consumption and cost per Twitch channel.</p>
          </div>

          <!-- Reuse the main filter bar values (overview) -->
          <div class="table-container">
            <table class="data-table" id="user-table">
              <thead><tr>
                <th>Twitch Channel</th>
                <th>Requests</th>
                <th>Prompt Tokens</th>
                <th>Completion Tokens</th>
                <th>Total Tokens</th>
                <th>Cost (USD)</th>
              </tr></thead>
              <tbody id="user-table-body">
                <tr><td colspan="6" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             DAILY BREAKDOWN TAB
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tab-daily">
          <div class="tab-header">
            <div class="tab-header-row">
              <div>
                <h3>ğŸ“… Daily Breakdown</h3>
                <p>Day-by-day usage across all users.</p>
              </div>
            </div>
          </div>

          <!-- Inline filter bar for daily tab -->
          <div class="filter-bar" id="filter-bar-daily">
            <label>Range:</label>
            <button class="quick-btn daily-range active" data-range="week">This Week</button>
            <button class="quick-btn daily-range" data-range="last-week">Last Week</button>
            <button class="quick-btn daily-range" data-range="month">This Month</button>
            <button class="quick-btn daily-range" data-range="last-month">Last Month</button>
            <button class="quick-btn daily-range" data-range="30d">Last 30 Days</button>
            <button class="quick-btn daily-range" data-range="all">All Time</button>
            <div class="filter-sep"></div>
            <label>Custom:</label>
            <input type="date" class="date-input" id="daily-custom-start" title="Start">
            <span style="color:#4b5563; font-size:0.8rem;">â€“</span>
            <input type="date" class="date-input" id="daily-custom-end" title="End">
            <button class="quick-btn" id="daily-apply-custom" style="border-color:#a78bfa; color:#a78bfa;">Apply</button>
          </div>

          <div class="table-container">
            <table class="data-table" id="daily-table">
              <thead><tr>
                <th>Date</th><th>Requests</th><th>Total Tokens</th><th>Cost (USD)</th>
              </tr></thead>
              <tbody id="daily-table-body">
                <tr><td colspan="4" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             BY MODEL TAB
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tab-models">
          <div class="tab-header">
            <h3>ğŸ¤– Usage by Model</h3>
            <p>Token distribution and cost split across AI providers.</p>
          </div>
          <div class="table-container">
            <table class="data-table" id="model-table">
              <thead><tr>
                <th>Model</th><th>Provider</th><th>Requests</th><th>Total Tokens</th><th>Cost (USD)</th>
              </tr></thead>
              <tbody id="model-table-body">
                <tr><td colspan="5" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             API COSTS TAB
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tab-costs">
          <div class="tab-header">
            <div class="tab-header-row">
              <div>
                <h3 style="color:#06b6d4;">ğŸ’µ API Cost Breakdown</h3>
                <p>Real-time cost tracking from your VirAI application usage.</p>
              </div>
              <button class="refresh-btn btn" id="refresh-costs" style="border-color:#06b6d4; color:#06b6d4;">â†» Refresh Costs</button>
            </div>
          </div>

          <div class="stats-grid" id="costs-stats">
            <div class="stat-card" style="border-color:#06b6d4;">
              <p class="stat-value" id="costs-total-tokens" style="color:#06b6d4;">-</p>
              <p class="stat-label">Total Tokens</p>
            </div>
            <div class="stat-card" style="border-color:#06b6d4;">
              <p class="stat-value" id="costs-input-tokens" style="color:#06b6d4;">-</p>
              <p class="stat-label">Input Tokens</p>
            </div>
            <div class="stat-card" style="border-color:#06b6d4;">
              <p class="stat-value" id="costs-output-tokens" style="color:#06b6d4;">-</p>
              <p class="stat-label">Output Tokens</p>
            </div>
            <div class="stat-card" style="border-color:#ef4444;">
              <p class="stat-value" id="costs-total-cost" style="color:#ef4444;">-</p>
              <p class="stat-label">Total Cost (MTD)</p>
            </div>
          </div>

          <span id="costs-period" style="color:#4b5563; font-size:0.8rem;"></span>

          <div class="usage-section" style="margin-top:18px;">
            <p class="usage-section-title">Cost by Model</p>
            <div class="table-container">
              <table class="data-table" id="costs-table">
                <thead><tr>
                  <th>Model</th><th>Requests</th><th>Input Tokens</th><th>Output Tokens</th><th>Cost</th>
                </tr></thead>
                <tbody id="costs-table-body">
                  <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="costs-error" style="display:none; margin-top:16px; padding:14px; background:rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.3); border-radius:10px; color:#f87171; font-size:0.85rem;"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             PRICING CONFIG TAB
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-content" id="tab-pricing">
          <div class="tab-header">
            <div class="tab-header-row">
              <div>
                <h3 style="color:#f59e0b;">âš™ï¸ Pricing Configuration</h3>
                <p>Update costs per 1M tokens. Changes affect cost calculations globally.</p>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="refresh-btn btn" id="refresh-pricing" style="border-color:#f59e0b; color:#f59e0b;">â†» Refresh</button>
                <button class="refresh-btn btn" id="save-pricing" style="border-color:#22c55e; color:#22c55e;">ğŸ’¾ Save All</button>
              </div>
            </div>
          </div>

          <div class="table-container" style="max-height:460px;">
            <table class="data-table" id="pricing-table">
              <thead><tr>
                <th>Provider</th><th>Model</th>
                <th>Input (per 1M tokens)</th>
                <th>Output (per 1M tokens)</th>
                <th>Last Updated</th>
              </tr></thead>
              <tbody id="pricing-table-body">
                <tr><td colspan="5" class="loading">Loading...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="usage-section" style="margin-top:18px; border-color:rgba(245,158,11,0.25); background:rgba(245,158,11,0.04);">
            <p class="usage-section-title" style="color:#f59e0b;">Add New Model</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
              <div>
                <label style="display:block; color:#6b7280; font-size:0.75rem; margin-bottom:4px;">Provider</label>
                <input type="text" id="new-provider" placeholder="e.g. openai" class="form-input-sm" style="width:120px;">
              </div>
              <div>
                <label style="display:block; color:#6b7280; font-size:0.75rem; margin-bottom:4px;">Model name</label>
                <input type="text" id="new-model" placeholder="gpt-4o" class="form-input-sm" style="width:190px;">
              </div>
              <div>
                <label style="display:block; color:#6b7280; font-size:0.75rem; margin-bottom:4px;">Input $ / 1M</label>
                <input type="number" id="new-input-cost" placeholder="0.00" step="0.001" class="form-input-sm" style="width:100px;">
              </div>
              <div>
                <label style="display:block; color:#6b7280; font-size:0.75rem; margin-bottom:4px;">Output $ / 1M</label>
                <input type="number" id="new-output-cost" placeholder="0.00" step="0.001" class="form-input-sm" style="width:100px;">
              </div>
              <button class="refresh-btn btn" id="add-model" style="border-color:#22c55e; color:#22c55e;">+ Add Model</button>
            </div>
          </div>
        </div>

      </main>
    </div><!-- /usage-shell -->
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://rgigtqpesabuyaumibaj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnaWd0cXBlc2FidXlhdW1pYmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTA2OTcsImV4cCI6MjA4NDMyNjY5N30.MaMvKpVPqCQONsNaYifkSvVFmYbT5c4HYpi_qieN4H0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl  = document.getElementById("admin-status");
    const contentEl = document.getElementById("admin-content");
    const statusWrap = document.getElementById("admin-status-wrap");

    // â”€â”€â”€ Admin check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkAdmin() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { window.location.href = "account.html"; return false; }

      const { data: profile, error } = await supabase
        .from("profiles").select("is_admin").eq("id", user.id).single();

      if (error || !profile?.is_admin) {
        statusEl.textContent = "Access Denied: You are not an admin.";
        statusEl.className = "auth-status error";
        return false;
      }

      statusWrap.classList.add("hidden");
      contentEl.classList.remove("hidden");
      return true;
    }

    // â”€â”€â”€ Date-range helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Global active range state
    let activeRange   = "week";
    let customStart   = null;   // ISO string or null
    let customEnd     = null;   // ISO string or null

    // Daily-tab independent range
    let dailyRange    = "week";
    let dailyCustomS  = null;
    let dailyCustomE  = null;

    function rangeToFilter(range, cStart = null, cEnd = null) {
      const now  = new Date();
      const ymd  = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());

      if (range === "custom" && cStart) {
        const start = new Date(cStart + "T00:00:00");
        const end   = cEnd ? new Date(cEnd + "T23:59:59") : new Date();
        return { startIso: start.toISOString(), endIso: end.toISOString() };
      }

      let startDate, endDate = null;

      switch (range) {
        case "today":
          startDate = ymd(now);
          break;
        case "yesterday": {
          const y = new Date(now); y.setDate(y.getDate() - 1);
          startDate = ymd(y);
          endDate   = new Date(y.getFullYear(), y.getMonth(), y.getDate(), 23, 59, 59, 999);
          break;
        }
        case "week": {
          const dow = now.getDay();
          startDate = ymd(new Date(now.getFullYear(), now.getMonth(), now.getDate() - dow));
          break;
        }
        case "last-week": {
          const dow = now.getDay();
          const endOfLastWeek   = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dow - 1, 23, 59, 59);
          const startOfLastWeek = new Date(endOfLastWeek.getFullYear(), endOfLastWeek.getMonth(), endOfLastWeek.getDate() - 6);
          startDate = startOfLastWeek;
          endDate   = endOfLastWeek;
          break;
        }
        case "month":
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case "last-month": {
          const lm = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          startDate = lm;
          endDate   = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
          break;
        }
        case "30d":
          startDate = new Date(now.getTime() - 30 * 86400 * 1000);
          break;
        case "all":
        default:
          return { startIso: null, endIso: null };
      }

      return {
        startIso: startDate ? startDate.toISOString() : null,
        endIso:   endDate   ? endDate.toISOString()   : null
      };
    }

    function getDateFilter() {
      // Returns startIso (or null for "all")
      const { startIso } = rangeToFilter(activeRange, customStart, customEnd);
      return startIso;
    }

    function getDateFilterFull() {
      return rangeToFilter(activeRange, customStart, customEnd);
    }

    function getDailyFilter() {
      return rangeToFilter(dailyRange, dailyCustomS, dailyCustomE);
    }

    // â”€â”€â”€ Quick-filter button wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setupQuickFilters() {
      // Overview quick buttons
      document.querySelectorAll("#filter-bar-overview .quick-btn[data-range]").forEach(btn => {
        btn.addEventListener("click", () => {
          if (btn.id === "apply-custom") return;
          activeRange  = btn.dataset.range;
          customStart  = null;
          customEnd    = null;
          document.querySelectorAll("#filter-bar-overview .quick-btn[data-range]").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          loadAllDataForRange();
        });
      });

      document.getElementById("apply-custom").addEventListener("click", () => {
        const s = document.getElementById("custom-start").value;
        const e = document.getElementById("custom-end").value;
        if (!s) return;
        activeRange = "custom";
        customStart = s;
        customEnd   = e || null;
        document.querySelectorAll("#filter-bar-overview .quick-btn[data-range]").forEach(b => b.classList.remove("active"));
        document.getElementById("apply-custom").classList.add("active");
        loadAllDataForRange();
      });

      // Daily tab quick buttons
      document.querySelectorAll(".daily-range").forEach(btn => {
        btn.addEventListener("click", () => {
          dailyRange   = btn.dataset.range;
          dailyCustomS = null;
          dailyCustomE = null;
          document.querySelectorAll(".daily-range").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          loadDailyUsage();
        });
      });

      document.getElementById("daily-apply-custom").addEventListener("click", () => {
        const s = document.getElementById("daily-custom-start").value;
        const e = document.getElementById("daily-custom-end").value;
        if (!s) return;
        dailyRange   = "custom";
        dailyCustomS = s;
        dailyCustomE = e || null;
        document.querySelectorAll(".daily-range").forEach(b => b.classList.remove("active"));
        document.getElementById("daily-apply-custom").classList.add("active");
        loadDailyUsage();
      });
    }

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function asNumber(value, fallback = 0) {
      const n = Number(value);
      return Number.isFinite(n) ? n : fallback;
    }

    function getTwitchName(row) {
      return String(row?.twitch_channel || "").trim();
    }

    async function fetchTokenUsageRows(startIso = null, endIso = null) {
      let query = supabase
        .from("token_usage")
        .select("created_at,license_key,twitch_channel,provider,model,prompt_tokens,completion_tokens,cost_usd");
      if (startIso) query = query.gte("created_at", startIso);
      if (endIso)   query = query.lte("created_at", endIso);
      const { data, error } = await query;
      if (error) throw error;
      return Array.isArray(data) ? data : [];
    }

    function monthRangeIso(monthsAgo = 0) {
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth() - monthsAgo, 1, 0, 0, 0, 0);
      const monthEnd   = new Date(now.getFullYear(), now.getMonth() - monthsAgo + 1, 0, 23, 59, 59, 999);
      return { startIso: monthStart.toISOString(), endIso: monthEnd.toISOString(), monthStart, monthEnd };
    }

    // â”€â”€â”€ Overview / stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadStats() {
      const { startIso, endIso } = getDateFilterFull();
      let data = [];
      try { data = await fetchTokenUsageRows(startIso, endIso); }
      catch (e) { console.error("Error loading stats:", e); }

      const totalRequests = data.length;
      const totalTokens   = data.reduce((s, r) => s + asNumber(r.prompt_tokens) + asNumber(r.completion_tokens), 0);
      const totalCost     = data.reduce((s, r) => s + asNumber(r.cost_usd), 0);
      const uniqueUsers   = new Set(data.map(r => String(r.license_key || "").trim()).filter(Boolean)).size;

      document.getElementById("total-requests").textContent = totalRequests.toLocaleString();
      document.getElementById("total-tokens").textContent   = totalTokens.toLocaleString();
      document.getElementById("total-cost").textContent     = "$" + totalCost.toFixed(4);
      document.getElementById("active-users").textContent   = uniqueUsers;

      // Overview top-users mini table
      const userStats = aggregateByUser(data);
      const topUsers  = Object.values(userStats).sort((a, b) => b.tokens - a.tokens).slice(0, 10);
      const topBody   = document.getElementById("overview-top-users-body");
      if (!topUsers.length) {
        topBody.innerHTML = `<tr><td colspan="4" class="loading">No data for selected range.</td></tr>`;
      } else {
        topBody.innerHTML = topUsers.map(u => `
          <tr>
            <td>${u.twitch
              ? `<a href="https://twitch.tv/${u.twitch}" target="_blank" style="color:#9146FF;text-decoration:none;font-weight:600;">ğŸ“º ${u.twitch}</a>`
              : `<span class="license-key" title="${u.license}">${u.license.substring(0,15)}â€¦</span>`
            }</td>
            <td>${u.requests.toLocaleString()}</td>
            <td>${u.tokens.toLocaleString()}</td>
            <td>$${u.cost.toFixed(4)}</td>
          </tr>`).join("");
      }

      // Mini charts
      buildOverviewDailyChart(data);
      buildOverviewModelChart(data);
    }

    function aggregateByUser(data) {
      const m = {};
      data.forEach(row => {
        const twitch  = getTwitchName(row);
        const license = String(row.license_key || "").trim();
        const key     = twitch || license;
        if (!key) return;
        if (!m[key]) m[key] = { twitch, license, requests: 0, tokens: 0, cost: 0 };
        m[key].requests++;
        m[key].tokens += asNumber(row.prompt_tokens) + asNumber(row.completion_tokens);
        m[key].cost   += asNumber(row.cost_usd);
      });
      return m;
    }

    // â”€â”€â”€ User usage table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadUserUsage() {
      const { startIso, endIso } = getDateFilterFull();
      const tbody = document.getElementById("user-table-body");
      let data = [];
      try { data = await fetchTokenUsageRows(startIso, endIso); }
      catch (e) { tbody.innerHTML = `<tr><td colspan="6">Error: ${e.message}</td></tr>`; return; }

      if (!data.length) { tbody.innerHTML = `<tr><td colspan="6">No usage data found.</td></tr>`; return; }

      const userStats = {};
      data.forEach(row => {
        const twitch  = getTwitchName(row);
        const license = String(row.license_key || "").trim();
        const key     = twitch || license;
        if (!key) return;
        if (!userStats[key]) userStats[key] = { twitch, license, requests: 0, prompt: 0, completion: 0, cost: 0 };
        userStats[key].requests++;
        userStats[key].prompt     += asNumber(row.prompt_tokens);
        userStats[key].completion += asNumber(row.completion_tokens);
        userStats[key].cost       += asNumber(row.cost_usd);
      });

      const sorted = Object.entries(userStats).sort((a, b) => b[1].cost - a[1].cost);
      tbody.innerHTML = sorted.map(([, s]) => `
        <tr>
          <td>${s.twitch
            ? `<a href="https://twitch.tv/${s.twitch}" target="_blank" style="color:#9146FF;text-decoration:none;font-weight:600;">ğŸ“º ${s.twitch}</a>`
            : `<span class="license-key" title="${s.license}">${s.license.substring(0,15)}â€¦</span>`
          }</td>
          <td>${s.requests.toLocaleString()}</td>
          <td>${s.prompt.toLocaleString()}</td>
          <td>${s.completion.toLocaleString()}</td>
          <td>${(s.prompt + s.completion).toLocaleString()}</td>
          <td>$${s.cost.toFixed(4)}</td>
        </tr>`).join("");
    }

    // â”€â”€â”€ Daily breakdown (independent filter) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDailyUsage() {
      const { startIso, endIso } = getDailyFilter();
      const tbody = document.getElementById("daily-table-body");
      let data = [];
      try { data = await fetchTokenUsageRows(startIso, endIso); }
      catch (e) { tbody.innerHTML = `<tr><td colspan="4">Error: ${e.message}</td></tr>`; return; }

      if (!data.length) { tbody.innerHTML = `<tr><td colspan="4">No usage data found.</td></tr>`; return; }

      const dailyStats = {};
      data.forEach(row => {
        const date = new Date(row.created_at).toISOString().split("T")[0];
        if (!dailyStats[date]) dailyStats[date] = { requests: 0, tokens: 0, cost: 0 };
        dailyStats[date].requests++;
        dailyStats[date].tokens += asNumber(row.prompt_tokens) + asNumber(row.completion_tokens);
        dailyStats[date].cost   += asNumber(row.cost_usd);
      });

      const sorted = Object.entries(dailyStats).sort((a, b) => b[0].localeCompare(a[0]));
      tbody.innerHTML = sorted.map(([date, s]) => `
        <tr>
          <td>${date}</td>
          <td>${s.requests.toLocaleString()}</td>
          <td>${s.tokens.toLocaleString()}</td>
          <td>$${s.cost.toFixed(4)}</td>
        </tr>`).join("");
    }

    // â”€â”€â”€ Model usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadModelUsage() {
      const { startIso, endIso } = getDateFilterFull();
      const tbody = document.getElementById("model-table-body");
      let data = [];
      try { data = await fetchTokenUsageRows(startIso, endIso); }
      catch (e) { tbody.innerHTML = `<tr><td colspan="5">Error: ${e.message}</td></tr>`; return; }

      if (!data.length) { tbody.innerHTML = `<tr><td colspan="5">No usage data found.</td></tr>`; return; }

      const modelStats = {};
      data.forEach(row => {
        const key = `${row.provider}|${row.model}`;
        if (!modelStats[key]) modelStats[key] = { provider: row.provider, model: row.model, requests: 0, tokens: 0, cost: 0 };
        modelStats[key].requests++;
        modelStats[key].tokens += asNumber(row.prompt_tokens) + asNumber(row.completion_tokens);
        modelStats[key].cost   += asNumber(row.cost_usd);
      });

      const sorted = Object.values(modelStats).sort((a, b) => b.requests - a.requests);
      tbody.innerHTML = sorted.map(s => `
        <tr>
          <td><span class="model-badge">${s.model}</span></td>
          <td>${s.provider}</td>
          <td>${s.requests.toLocaleString()}</td>
          <td>${s.tokens.toLocaleString()}</td>
          <td>$${s.cost.toFixed(4)}</td>
        </tr>`).join("");
    }

    // â”€â”€â”€ Load everything for the current global range â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAllDataForRange() {
      await Promise.all([
        loadStats(),
        loadUserUsage(),
        loadModelUsage(),
        loadRevenue()
      ]);
    }

    async function loadAllData() {
      await Promise.all([
        loadStats(),
        loadUserUsage(),
        loadDailyUsage(),
        loadModelUsage(),
        loadPricing(),
        loadRevenue()
      ]);
    }

    // â”€â”€â”€ Chart instances â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let revenueChart      = null;
    let dailyCostsChart   = null;
    let modelCostsChart   = null;
    let overviewDailyChart = null;
    let overviewModelChart = null;

    const CHART_COLORS = ['#d946ef','#8b5cf6','#06b6d4','#22c55e','#f59e0b','#ef4444','#ec4899','#a78bfa'];

    function chartDefaults() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: '#6b7280' }, grid: { color: 'rgba(124,58,237,0.1)' } },
          x: { ticks: { color: '#6b7280', maxRotation: 40 }, grid: { display: false } }
        }
      };
    }

    // Overview â€“ daily request line chart
    function buildOverviewDailyChart(data) {
      const ctx = document.getElementById("overviewDailyChart");
      if (!ctx) return;
      if (overviewDailyChart) overviewDailyChart.destroy();

      const dayMap = {};
      data.forEach(r => {
        const d = new Date(r.created_at).toISOString().split("T")[0];
        dayMap[d] = (dayMap[d] || 0) + 1;
      });
      const sorted = Object.entries(dayMap).sort((a, b) => a[0].localeCompare(b[0])).slice(-14);

      overviewDailyChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: sorted.map(([d]) => new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric" })),
          datasets: [{
            label: "Requests",
            data: sorted.map(([, v]) => v),
            borderColor: "#a78bfa",
            backgroundColor: "rgba(167,139,250,0.12)",
            fill: true, tension: 0.35, pointRadius: 3, pointBackgroundColor: "#a78bfa"
          }]
        },
        options: { ...chartDefaults(), plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.raw + " req" } } } }
      });
    }

    // Overview â€“ model token doughnut
    function buildOverviewModelChart(data) {
      const ctx = document.getElementById("overviewModelChart");
      if (!ctx) return;
      if (overviewModelChart) overviewModelChart.destroy();

      const modelMap = {};
      data.forEach(r => {
        const k = r.model || "unknown";
        modelMap[k] = (modelMap[k] || 0) + asNumber(r.prompt_tokens) + asNumber(r.completion_tokens);
      });
      const entries = Object.entries(modelMap).sort((a, b) => b[1] - a[1]);

      overviewModelChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: entries.map(([k]) => k),
          datasets: [{ data: entries.map(([, v]) => v), backgroundColor: CHART_COLORS, borderColor: "rgba(15,5,30,0.8)", borderWidth: 2 }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: "right", labels: { color: "#9ca3af", boxWidth: 10, padding: 8, font: { size: 11 } } },
            tooltip: { callbacks: { label: c => c.label + ": " + c.raw.toLocaleString() } }
          }
        }
      });
    }

    async function loadRevenueFallback(monthsAgo = 0) {
      const tbody = document.getElementById("revenue-daily-body");
      const { startIso, endIso, monthStart, monthEnd } = monthRangeIso(monthsAgo);

      const { data, error } = await supabase
        .from("token_usage")
        .select("created_at,provider,model,prompt_tokens,completion_tokens,cost_usd")
        .gte("created_at", startIso)
        .lte("created_at", endIso);

      if (error) {
        console.error("Revenue fallback error:", error);
        tbody.innerHTML = `<tr><td colspan="5">Error loading data</td></tr>`;
        return;
      }

      const rows = Array.isArray(data) ? data : [];
      const dayMap = {};
      const byModel = {};
      let inputTokens = 0;
      let outputTokens = 0;
      let totalCost = 0;

      rows.forEach((r) => {
        const d = new Date(r.created_at).toISOString().split("T")[0];
        if (!dayMap[d]) dayMap[d] = { date: d, requests: 0, input: 0, output: 0, cost: 0 };
        const inTok = asNumber(r.prompt_tokens);
        const outTok = asNumber(r.completion_tokens);
        const c = asNumber(r.cost_usd);
        dayMap[d].requests += 1;
        dayMap[d].input += inTok;
        dayMap[d].output += outTok;
        dayMap[d].cost += c;
        inputTokens += inTok;
        outputTokens += outTok;
        totalCost += c;

        const modelKey = `${r.provider || "unknown"}/${r.model || "unknown"}`;
        if (!byModel[modelKey]) byModel[modelKey] = { requests: 0, input: 0, output: 0, cost: 0 };
        byModel[modelKey].requests += 1;
        byModel[modelKey].input += inTok;
        byModel[modelKey].output += outTok;
        byModel[modelKey].cost += c;
      });

      const { data: plans } = await supabase
        .from("subscription_plans")
        .select("*")
        .eq("is_active", true)
        .limit(1);
      const activePlan = plans?.[0] || null;
      const planPrice = asNumber(activePlan?.price_monthly, 0);
      if (activePlan) {
        document.getElementById("plan-name").value = activePlan.name || "";
        document.getElementById("plan-price").value = activePlan.price_monthly || "";
        document.getElementById("plan-id").textContent = activePlan.id || "";
      }

      const { count: activeSubs } = await supabase
        .from("licenses")
        .select("id", { count: "exact", head: true })
        .eq("status", "active");

      const grossRevenue = asNumber(activeSubs) * planPrice;
      const profitBeforeTax = grossRevenue - totalCost;
      const taxReserve = Math.max(0, profitBeforeTax * 0.3);
      const netProfitAfterTax = profitBeforeTax - taxReserve;
      const profitMargin = grossRevenue > 0 ? (netProfitAfterTax / grossRevenue) * 100 : 0;
      const costPerUser = asNumber(activeSubs) > 0 ? totalCost / asNumber(activeSubs) : 0;

      document.getElementById("active-subs").textContent = asNumber(activeSubs).toLocaleString();
      document.getElementById("gross-revenue").textContent = "$" + grossRevenue.toFixed(2);
      document.getElementById("api-costs").textContent = "-$" + totalCost.toFixed(4);
      document.getElementById("tax-reserve").textContent = "-$" + taxReserve.toFixed(2);
      document.getElementById("net-profit").textContent = "$" + netProfitAfterTax.toFixed(2);
      document.getElementById("profit-margin").textContent = profitMargin.toFixed(1) + "%";
      document.getElementById("cost-per-user").textContent = "$" + costPerUser.toFixed(4);
      document.getElementById("price-per-sub").textContent = "$" + planPrice.toFixed(2);
      document.getElementById("billing-period-text").textContent =
        `${monthStart.toLocaleString("en-US", { month: "long" })} â€¢ Fallback mode`;

      document.getElementById("proj-revenue").textContent = "$" + grossRevenue.toFixed(2);
      document.getElementById("proj-costs").textContent = "$" + totalCost.toFixed(4);
      document.getElementById("proj-tax").textContent = "$" + taxReserve.toFixed(2);
      document.getElementById("proj-takehome").textContent = "$" + netProfitAfterTax.toFixed(2);

      const daily = Object.values(dayMap).sort((a, b) => b.date.localeCompare(a.date));
      if (!daily.length) {
        tbody.innerHTML = `<tr><td colspan="5">No usage data for this period.</td></tr>`;
      } else {
        tbody.innerHTML = daily.map(d => `
          <tr>
            <td>${new Date(d.date).toLocaleDateString()}</td>
            <td>${d.requests.toLocaleString()}</td>
            <td>${d.input.toLocaleString()}</td>
            <td>${d.output.toLocaleString()}</td>
            <td style="color: #ef4444;">$${d.cost.toFixed(4)}</td>
          </tr>
        `).join("");
      }

      buildRevenueChart(grossRevenue, totalCost, taxReserve, netProfitAfterTax);
      buildDailyCostsChart(daily);
      buildModelCostsChart(byModel);
      updateCostsTab({
        totals: {
          total_tokens: inputTokens + outputTokens,
          input_tokens: inputTokens,
          output_tokens: outputTokens,
          cost_usd: totalCost
        },
        by_model: byModel,
        billing_period: {
          month_name: monthStart.toLocaleString("en-US", { month: "long", year: "numeric" }),
          days_elapsed: new Date().getDate(),
          days_total: monthEnd.getDate()
        }
      });
    }

    // Load Revenue & Business Metrics
    async function loadRevenue(monthsAgo = 0) {
      const tbody = document.getElementById("revenue-daily-body");
      tbody.innerHTML = `<tr><td colspan="5" class="loading">Loading...</td></tr>`;

      try {
        const { data: sessionData } = await supabase.auth.getSession();
        const token = sessionData?.session?.access_token;

        const response = await fetch(`${SUPABASE_URL}/functions/v1/openai-usage?action=usage&month=${monthsAgo}`, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });

        const result = await response.json();

        if (!response.ok || result.error) {
          console.warn("Revenue edge-function failed, using fallback:", result?.error || response.statusText);
          await loadRevenueFallback(monthsAgo);
          return;
        }

        // Calculate with 30% tax
        const TAX_RATE = 0.30;
        const rev = result.revenue || {};
        const grossRevenue = rev.gross_monthly || 0;
        const apiCosts = rev.api_costs || 0;
        const profitBeforeTax = grossRevenue - apiCosts;
        const taxReserve = profitBeforeTax * TAX_RATE;
        const netProfitAfterTax = profitBeforeTax - taxReserve;
        const profitMargin = grossRevenue > 0 ? (netProfitAfterTax / grossRevenue) * 100 : 0;

        // Update revenue stats
        document.getElementById("active-subs").textContent = rev.active_subscribers || 0;
        document.getElementById("gross-revenue").textContent = "$" + grossRevenue.toFixed(2);
        document.getElementById("api-costs").textContent = "-$" + apiCosts.toFixed(4);
        document.getElementById("tax-reserve").textContent = "-$" + taxReserve.toFixed(2);
        document.getElementById("net-profit").textContent = "$" + netProfitAfterTax.toFixed(2);
        document.getElementById("profit-margin").textContent = profitMargin.toFixed(1) + "%";
        document.getElementById("cost-per-user").textContent = "$" + (rev.cost_per_user || 0).toFixed(4);
        document.getElementById("price-per-sub").textContent = "$" + (rev.price_per_sub || 0).toFixed(2);
        
        // Update billing period
        const period = result.billing_period;
        document.getElementById("billing-period-text").textContent = 
          `${period?.month_name || ""} â€¢ ${period?.days_elapsed || 0} of ${period?.days_total || 30} days`;
        
        // Update projection summary
        document.getElementById("proj-revenue").textContent = "$" + grossRevenue.toFixed(2);
        document.getElementById("proj-costs").textContent = "$" + apiCosts.toFixed(4);
        document.getElementById("proj-tax").textContent = "$" + taxReserve.toFixed(2);
        document.getElementById("proj-takehome").textContent = "$" + netProfitAfterTax.toFixed(2);
        
        // Load plan settings
        const { data: plans } = await supabase
          .from("subscription_plans")
          .select("*")
          .eq("is_active", true)
          .limit(1);
        
        if (plans?.length) {
          document.getElementById("plan-name").value = plans[0].name || "";
          document.getElementById("plan-price").value = plans[0].price_monthly || "";
          document.getElementById("plan-id").textContent = plans[0].id;
        }

        // Daily breakdown table
        const daily = result.daily || [];
        if (daily.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5">No usage data for this period.</td></tr>`;
        } else {
          tbody.innerHTML = daily.map(d => `
            <tr>
              <td>${new Date(d.date).toLocaleDateString()}</td>
              <td>${d.requests.toLocaleString()}</td>
              <td>${d.input.toLocaleString()}</td>
              <td>${d.output.toLocaleString()}</td>
              <td style="color: #ef4444;">$${d.cost.toFixed(4)}</td>
            </tr>
          `).join("");
        }
        
        // Build charts
        buildRevenueChart(grossRevenue, apiCosts, taxReserve, netProfitAfterTax);
        buildDailyCostsChart(daily);
        buildModelCostsChart(result.by_model || {});
        
        // Also update costs tab data
        updateCostsTab(result);
        
      } catch (err) {
        console.warn("Revenue request failed, using fallback:", err);
        await loadRevenueFallback(monthsAgo);
      }
    }
    
    // Revenue Breakdown Bar Chart
    function buildRevenueChart(gross, costs, tax, net) {
      const ctx = document.getElementById('revenueChart');
      if (!ctx) return;
      
      if (revenueChart) revenueChart.destroy();
      
      revenueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Gross Revenue', 'API Costs', 'Tax (30%)', 'Net Profit'],
          datasets: [{
            data: [gross, costs, tax, net],
            backgroundColor: ['#22c55e', '#ef4444', '#f59e0b', '#10b981'],
            borderColor: ['#22c55e', '#ef4444', '#f59e0b', '#10b981'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => '$' + ctx.raw.toFixed(2)
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                color: '#a1a1aa',
                callback: (v) => '$' + v.toFixed(2)
              },
              grid: { color: '#2d1b4e' }
            },
            x: {
              ticks: { color: '#a1a1aa' },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // Daily Costs Line Chart
    function buildDailyCostsChart(daily) {
      const ctx = document.getElementById('dailyCostsChart');
      if (!ctx) return;
      
      if (dailyCostsChart) dailyCostsChart.destroy();
      
      // Sort by date ascending and take last 14 days
      const sorted = [...daily].sort((a, b) => a.date.localeCompare(b.date)).slice(-14);
      
      dailyCostsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sorted.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [{
            label: 'Daily Cost',
            data: sorted.map(d => d.cost),
            borderColor: '#06b6d4',
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#06b6d4'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => '$' + ctx.raw.toFixed(4)
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                color: '#a1a1aa',
                callback: (v) => '$' + v.toFixed(4)
              },
              grid: { color: '#2d1b4e' }
            },
            x: {
              ticks: { color: '#a1a1aa', maxRotation: 45 },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // Model Costs Doughnut Chart
    function buildModelCostsChart(byModel) {
      const ctx = document.getElementById('modelCostsChart');
      if (!ctx) return;
      
      if (modelCostsChart) modelCostsChart.destroy();
      
      const entries = Object.entries(byModel).sort((a, b) => b[1].cost - a[1].cost);
      const labels = entries.map(([model]) => model.split('/').pop());
      const data = entries.map(([, stats]) => stats.cost);
      
      const colors = ['#d946ef', '#8b5cf6', '#06b6d4', '#22c55e', '#f59e0b', '#ef4444', '#ec4899'];
      
      modelCostsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors.slice(0, data.length),
            borderColor: '#0f0816',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#a1a1aa', boxWidth: 12, padding: 8 }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.label + ': $' + ctx.raw.toFixed(4)
              }
            }
          }
        }
      });
    }
    
    // Update Costs Tab with same data
    function updateCostsTab(result) {
      const totals = result.totals || {};
      const costsTbody = document.getElementById("costs-table-body");
      
      document.getElementById("costs-total-tokens").textContent = (totals.total_tokens || 0).toLocaleString();
      document.getElementById("costs-input-tokens").textContent = (totals.input_tokens || 0).toLocaleString();
      document.getElementById("costs-output-tokens").textContent = (totals.output_tokens || 0).toLocaleString();
      document.getElementById("costs-total-cost").textContent = "$" + (totals.cost_usd || 0).toFixed(4);
      
      const period = result.billing_period;
      document.getElementById("costs-period").textContent = 
        `${period?.month_name || ""} (${period?.days_elapsed || 0} days)`;
      
      // Model breakdown
      const models = result.by_model || {};
      const rows = Object.entries(models)
        .sort((a, b) => b[1].cost - a[1].cost)
        .map(([model, stats]) => ({
          model,
          requests: stats.requests,
          input: stats.input,
          output: stats.output,
          cost: stats.cost
        }));
      
      if (rows.length === 0) {
        costsTbody.innerHTML = `<tr><td colspan="5">No cost data yet.</td></tr>`;
      } else {
        costsTbody.innerHTML = rows.map(r => `
          <tr>
            <td><span class="model-badge">${r.model}</span></td>
            <td>${r.requests.toLocaleString()}</td>
            <td>${r.input.toLocaleString()}</td>
            <td>${r.output.toLocaleString()}</td>
            <td style="color: #ef4444;">$${r.cost.toFixed(4)}</td>
          </tr>
        `).join("");
      }
    }
    
    // Save subscription plan
    async function savePlan() {
      const planId = document.getElementById("plan-id").textContent;
      const name = document.getElementById("plan-name").value;
      const price = parseFloat(document.getElementById("plan-price").value);
      
      if (!planId) {
        alert("No plan found to update");
        return;
      }
      
      const { error } = await supabase
        .from("subscription_plans")
        .update({ name, price_monthly: price, updated_at: new Date().toISOString() })
        .eq("id", planId);
      
      if (error) {
        alert("Failed to update plan: " + error.message);
      } else {
        alert("Plan updated!");
        loadRevenue();
      }
    }

    // Load model pricing
    async function loadPricing() {
      const tbody = document.getElementById("pricing-table-body");
      
      const { data, error } = await supabase
        .from("model_pricing")
        .select("*")
        .order("provider")
        .order("model");

      if (error) {
        tbody.innerHTML = `<tr><td colspan="5">Error loading pricing: ${error.message}</td></tr>`;
        return;
      }

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">No pricing data found.</td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(row => `
        <tr data-id="${row.id}">
          <td>${row.provider}</td>
          <td><span class="model-badge">${row.model}</span></td>
          <td>
            <input type="number" class="pricing-input input-cost" value="${row.input_cost_per_million}" step="0.001" 
              style="background: #0f0816; border: 1px solid #2d1b4e; border-radius: 4px; padding: 5px 8px; color: white; width: 100px;">
          </td>
          <td>
            <input type="number" class="pricing-input output-cost" value="${row.output_cost_per_million}" step="0.001"
              style="background: #0f0816; border: 1px solid #2d1b4e; border-radius: 4px; padding: 5px 8px; color: white; width: 100px;">
          </td>
          <td style="color: #a1a1aa; font-size: 0.85rem;">${new Date(row.updated_at).toLocaleDateString()}</td>
        </tr>
      `).join("");
    }

    // Save pricing changes
    async function savePricing() {
      const rows = document.querySelectorAll("#pricing-table-body tr[data-id]");
      const updates = [];

      rows.forEach(row => {
        const id = row.dataset.id;
        const inputCost = parseFloat(row.querySelector(".input-cost").value) || 0;
        const outputCost = parseFloat(row.querySelector(".output-cost").value) || 0;
        updates.push({ id, input_cost_per_million: inputCost, output_cost_per_million: outputCost, updated_at: new Date().toISOString() });
      });

      let successCount = 0;
      for (const update of updates) {
        const { error } = await supabase
          .from("model_pricing")
          .update({
            input_cost_per_million: update.input_cost_per_million,
            output_cost_per_million: update.output_cost_per_million,
            updated_at: update.updated_at
          })
          .eq("id", update.id);
        
        if (!error) successCount++;
      }

      alert(`Saved ${successCount} of ${updates.length} pricing entries.`);
      await loadPricing();
    }

    // Add new model pricing
    async function addModelPricing() {
      const provider = document.getElementById("new-provider").value.trim().toLowerCase();
      const model = document.getElementById("new-model").value.trim();
      const inputCost = parseFloat(document.getElementById("new-input-cost").value) || 0;
      const outputCost = parseFloat(document.getElementById("new-output-cost").value) || 0;

      if (!provider || !model) {
        alert("Please enter provider and model name.");
        return;
      }

      const { error } = await supabase
        .from("model_pricing")
        .insert({
          provider,
          model,
          input_cost_per_million: inputCost,
          output_cost_per_million: outputCost
        });

      if (error) {
        alert("Error adding model: " + error.message);
        return;
      }

      // Clear inputs
      document.getElementById("new-provider").value = "";
      document.getElementById("new-model").value = "";
      document.getElementById("new-input-cost").value = "";
      document.getElementById("new-output-cost").value = "";

      alert("Model added successfully!");
      await loadPricing();
    }

    // â”€â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll(".nav-tab[data-tab]").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".nav-tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => {
          c.classList.remove("active");
          c.style.animation = "none";
        });
        tab.classList.add("active");
        const panel = document.getElementById(`tab-${tab.dataset.tab}`);
        if (panel) {
          panel.classList.add("active");
          void panel.offsetWidth;
          panel.style.animation = "";
        }
      });
    });

    // â”€â”€â”€ Refresh / event wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("refresh-btn").addEventListener("click", loadAllDataForRange);
    document.getElementById("sidebar-refresh").addEventListener("click", (e) => { e.preventDefault(); loadAllData(); });

    document.getElementById("refresh-revenue").addEventListener("click", () => {
      loadRevenue(parseInt(document.getElementById("revenue-month").value));
    });
    document.getElementById("revenue-month").addEventListener("change", (e) => {
      loadRevenue(parseInt(e.target.value));
    });
    document.getElementById("save-plan").addEventListener("click", savePlan);
    document.getElementById("refresh-costs").addEventListener("click", () => loadRevenue(0));
    document.getElementById("refresh-pricing").addEventListener("click", loadPricing);
    document.getElementById("save-pricing").addEventListener("click", savePricing);
    document.getElementById("add-model").addEventListener("click", addModelPricing);

    // â”€â”€â”€ Month selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadMonthSelector() {
      const select = document.getElementById("revenue-month");
      try {
        const { data: sessionData } = await supabase.auth.getSession();
        const token = sessionData?.session?.access_token;
        const response = await fetch(`${SUPABASE_URL}/functions/v1/openai-usage?action=months`, {
          headers: { "apikey": SUPABASE_ANON_KEY, "Authorization": `Bearer ${token}` }
        });
        const result = await response.json();
        if (result.months?.length) {
          select.innerHTML = result.months.map(m =>
            `<option value="${m.value}">${m.label}${m.is_current ? " (Current)" : ""}</option>`
          ).join("");
          return;
        }
      } catch (_) { /* fall through */ }

      // Local fallback
      const opts = [];
      for (let i = 0; i < 12; i++) {
        const d = new Date(); d.setMonth(d.getMonth() - i);
        const label = d.toLocaleString("en-US", { month: "long", year: "numeric" });
        opts.push(`<option value="${i}" ${i === 0 ? "selected" : ""}>${label}${i === 0 ? " (Current)" : ""}</option>`);
      }
      select.innerHTML = opts.join("");
    }

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      const isAdmin = await checkAdmin();
      if (!isAdmin) return;
      setupQuickFilters();
      await loadMonthSelector();
      await loadAllData();
    }

    init();
  </script>
</body>
</html>
